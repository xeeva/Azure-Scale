<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Azure Resource Relationship Graph</title>
<style>
:root {
    --bg-primary: #0a0e1a;
    --bg-card: #1a2035;
    --bg-elevated: #1e2a42;
    --border: #1e2d4a;
    --border-glow: #0d4f8b;
    --text: #e2e8f0;
    --text-muted: #8892a8;
    --text-bright: #f1f5f9;
    --neon-cyan: #22d3ee;
    --neon-blue: #60a5fa;
    --neon-purple: #a78bfa;
    --neon-pink: #f472b6;
    --neon-green: #34d399;
    --neon-orange: #fb923c;
    --azure-blue: #3b9eff;
    --panel-width: 260px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
    font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg-primary);
    color: var(--text);
    overflow: hidden;
    height: 100vh;
}

/* Header */
.header {
    position: fixed;
    top: 0; left: var(--panel-width); right: 0;
    z-index: 10;
    background: rgba(10, 14, 26, 0.9);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    padding: 0.75rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.header h1 {
    font-size: 1.15rem;
    font-weight: 600;
    color: var(--neon-blue);
    text-shadow: 0 0 15px rgba(96,165,250,0.3);
}
.header .subtitle {
    font-size: 0.78rem;
    color: var(--text-muted);
    margin-top: 0.1rem;
}
.header-right {
    display: flex;
    gap: 0.6rem;
    align-items: center;
}
.btn {
    background: rgba(59,158,255,0.12);
    border: 1px solid rgba(59,158,255,0.3);
    color: var(--neon-cyan);
    padding: 0.3rem 0.65rem;
    border-radius: 6px;
    font-size: 0.75rem;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.2s;
}
.btn:hover {
    background: rgba(59,158,255,0.25);
    box-shadow: 0 0 12px rgba(34,211,238,0.2);
}
.btn.active {
    background: rgba(34,211,238,0.2);
    border-color: var(--neon-cyan);
}
.back-link {
    color: var(--azure-blue);
    text-decoration: none;
    font-size: 0.78rem;
    transition: color 0.2s, text-shadow 0.2s;
}
.back-link:hover {
    color: var(--neon-cyan);
    text-shadow: 0 0 8px rgba(34,211,238,0.3);
}

/* Left filter panel */
.filter-panel {
    position: fixed;
    top: 0; left: 0; bottom: 0;
    width: var(--panel-width);
    background: rgba(16, 20, 35, 0.97);
    backdrop-filter: blur(12px);
    border-right: 1px solid var(--border);
    z-index: 15;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}
.panel-header {
    padding: 1rem 1.25rem 0.75rem;
    border-bottom: 1px solid var(--border);
}
.panel-header h2 {
    font-size: 0.95rem;
    color: var(--neon-blue);
    text-shadow: 0 0 10px rgba(96,165,250,0.2);
    margin-bottom: 0.15rem;
}
.panel-header p {
    font-size: 0.72rem;
    color: var(--text-muted);
}
.panel-body {
    flex: 1;
    overflow-y: auto;
    padding: 0.75rem 1rem;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
}
.panel-body::-webkit-scrollbar { width: 5px; }
.panel-body::-webkit-scrollbar-track { background: transparent; }
.panel-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

.filter-group {
    margin-bottom: 1.25rem;
}
.filter-group h3 {
    font-size: 0.72rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.filter-group h3 .count {
    color: var(--neon-cyan);
    font-size: 0.68rem;
    text-shadow: 0 0 6px rgba(34,211,238,0.2);
}
.filter-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.3rem 0.4rem;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.15s;
    font-size: 0.78rem;
    color: var(--text);
    user-select: none;
}
.filter-item:hover { background: rgba(59,158,255,0.08); }
.filter-item.dimmed { opacity: 0.35; }

.filter-cb {
    width: 14px;
    height: 14px;
    border: 1.5px solid var(--text-muted);
    border-radius: 3px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
}
.filter-item.active .filter-cb {
    border-color: var(--neon-cyan);
    background: rgba(34,211,238,0.15);
}
.filter-item.active .filter-cb::after {
    content: '';
    width: 7px;
    height: 7px;
    border-radius: 1.5px;
    background: var(--neon-cyan);
    box-shadow: 0 0 4px rgba(34,211,238,0.5);
}
.cat-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}

.filter-actions {
    display: flex;
    gap: 0.4rem;
    margin-top: 0.35rem;
}
.filter-link {
    font-size: 0.68rem;
    color: var(--azure-blue);
    cursor: pointer;
    transition: color 0.2s;
    background: none;
    border: none;
    font-family: inherit;
    padding: 0;
}
.filter-link:hover { color: var(--neon-cyan); }

.region-search {
    width: 100%;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 5px;
    color: var(--text);
    font-family: inherit;
    font-size: 0.75rem;
    padding: 0.35rem 0.5rem;
    margin-bottom: 0.5rem;
    outline: none;
    transition: border-color 0.2s;
}
.region-search:focus { border-color: var(--azure-blue); }
.region-search::placeholder { color: var(--text-muted); opacity: 0.5; }

/* Legend at bottom of panel */
.panel-legend {
    padding: 0.75rem 1rem;
    border-top: 1px solid var(--border);
    font-size: 0.72rem;
    color: #4a5568;
}
.panel-legend .legend-item {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    margin-bottom: 0.2rem;
    color: var(--text-muted);
}
.legend-line-thin {
    width: 16px; height: 1px; background: rgba(59,158,255,0.2); flex-shrink: 0;
}
.legend-line-thick {
    width: 16px; height: 3px; background: rgba(59,158,255,0.5); border-radius: 1px; flex-shrink: 0;
}

/* Canvas */
canvas {
    position: fixed;
    top: 0; left: var(--panel-width); right: 0; bottom: 0;
    display: block;
    cursor: grab;
}
canvas:active { cursor: grabbing; }

/* Tooltip */
.tooltip {
    position: fixed;
    display: none;
    background: rgba(26, 32, 53, 0.95);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    font-size: 0.82rem;
    max-width: 340px;
    pointer-events: none;
    z-index: 20;
    box-shadow: 0 4px 24px rgba(0,0,0,0.4), 0 0 20px rgba(59,158,255,0.08);
}
.tooltip h3 {
    color: var(--neon-cyan);
    font-size: 0.9rem;
    margin-bottom: 0.35rem;
    text-shadow: 0 0 8px rgba(34,211,238,0.3);
}
.tooltip .tt-type {
    color: var(--text-muted);
    font-size: 0.75rem;
    margin-bottom: 0.5rem;
}
.tooltip .tt-stat {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    padding: 0.15rem 0;
    border-bottom: 1px solid rgba(255,255,255,0.04);
}
.tooltip .tt-stat:last-child { border-bottom: none; }
.tooltip .tt-label { color: var(--text-muted); }
.tooltip .tt-value { color: var(--text-bright); font-weight: 600; }
.tooltip .tt-regions {
    margin-top: 0.4rem;
    padding-top: 0.4rem;
    border-top: 1px solid rgba(255,255,255,0.06);
    font-size: 0.72rem;
    color: var(--text-muted);
    line-height: 1.4;
}
.tooltip .tt-regions strong { color: var(--neon-blue); }
</style>
</head>
<body>

<!-- Left filter panel -->
<div class="filter-panel">
    <div class="panel-header">
        <h2>Filters</h2>
        <p>Filter by category or region availability</p>
    </div>
    <div class="panel-body">
        <!-- Categories -->
        <div class="filter-group" id="cat-filters">
            <h3>Categories <span class="count" id="cat-count"></span></h3>
            <!-- populated by JS -->
        </div>

        <!-- Regions -->
        <div class="filter-group" id="region-filters">
            <h3>Regions <span class="count" id="region-count"></span></h3>
            <input type="text" class="region-search" id="region-search" placeholder="Search regions...">
            <div class="filter-actions">
                <button class="filter-link" id="regions-all">Select All</button>
                <button class="filter-link" id="regions-none">Clear All</button>
            </div>
            <div id="region-list" style="margin-top:0.4rem">
                <!-- populated by JS -->
            </div>
        </div>
    </div>
    <div class="panel-legend">
        <div class="legend-item"><div class="legend-line-thick"></div> Strong dependency</div>
        <div class="legend-item"><div class="legend-line-thin"></div> Weaker integration</div>
        <div style="margin-top:0.3rem;color:#3a4158">Node size = complexity score</div>
    </div>
</div>

<!-- Header -->
<div class="header">
    <div>
        <h1>Azure Resource Relationship Graph</h1>
        <div class="subtitle">Force-directed visualisation of service interdependencies</div>
    </div>
    <div class="header-right">
        <button class="btn" id="btn-reset">Reset View</button>
        <button class="btn" id="btn-freeze">Freeze</button>
        <a href="index.html" class="back-link">&larr; Back to Report</a>
    </div>
</div>

<canvas id="graph"></canvas>
<div class="tooltip" id="tooltip"></div>

<script>
// ============================================================
// DATA
// ============================================================
const CATEGORIES = {
    compute:    { color: '#3b9eff', glow: 'rgba(59,158,255,0.5)',   label: 'Compute' },
    networking: { color: '#22d3ee', glow: 'rgba(34,211,238,0.5)',   label: 'Networking' },
    data:       { color: '#a78bfa', glow: 'rgba(167,139,250,0.5)', label: 'Data & Storage' },
    security:   { color: '#f472b6', glow: 'rgba(244,114,182,0.5)', label: 'Security & Identity' },
    app:        { color: '#34d399', glow: 'rgba(52,211,153,0.5)',   label: 'App Platform' },
    monitoring: { color: '#fb923c', glow: 'rgba(251,146,60,0.5)',   label: 'Monitoring & Mgmt' },
};

const nodes = [
    {
        id: 'Compute', label: 'Compute', category: 'compute',
        score: 1407, params: 1407, resourceTypes: 38, skus: 4635, operations: 418, products: 18,
        desc: 'Virtual Machines, Scale Sets, Managed Disks, Galleries, Dedicated Hosts',
        regions: ['East US','East US 2','West US','West US 2','West US 3','Central US','North Central US','South Central US','West Central US','North Europe','West Europe','UK South','UK West','France Central','Germany West Central','Switzerland North','Norway East','Sweden Central','Poland Central','Italy North','Spain Central','Canada Central','Canada East','Brazil South','Australia East','Australia Southeast','Japan East','Japan West','Korea Central','Southeast Asia','East Asia','Central India','South India','UAE North','South Africa North','Qatar Central']
    },
    {
        id: 'Network', label: 'Network', category: 'networking',
        score: 8549, params: 8549, resourceTypes: 172, skus: 90, operations: 1437, products: 50,
        desc: 'VNets, NSGs, Load Balancers, Firewalls, VPN Gateways, DNS, Front Door',
        regions: ['East US','East US 2','West US','West US 2','West US 3','Central US','North Central US','South Central US','North Europe','West Europe','UK South','UK West','France Central','Germany West Central','Switzerland North','Norway East','Sweden Central','Canada Central','Canada East','Brazil South','Australia East','Australia Southeast','Japan East','Japan West','Korea Central','Southeast Asia','East Asia','Central India','UAE North','South Africa North','Qatar Central','Poland Central','Italy North','Israel Central','Mexico Central']
    },
    {
        id: 'Storage', label: 'Storage', category: 'data',
        score: 1855, params: 1855, resourceTypes: 36, skus: 306, operations: 346, products: 16,
        desc: 'Blob, Files, Queues, Tables, Data Lake Gen2, Immutable Storage',
        regions: ['East US','East US 2','West US','West US 2','West US 3','Central US','North Central US','South Central US','North Europe','West Europe','UK South','UK West','France Central','Germany West Central','Switzerland North','Norway East','Sweden Central','Canada Central','Canada East','Brazil South','Australia East','Australia Southeast','Japan East','Japan West','Korea Central','Southeast Asia','East Asia','Central India','UAE North','South Africa North','Qatar Central','Poland Central','Italy North']
    },
    {
        id: 'KeyVault', label: 'Key Vault', category: 'security',
        score: 418, params: 418, resourceTypes: 10, skus: 0, operations: 155, products: 11,
        desc: 'Keys, Secrets, Certificates, Managed HSM, Access Policies',
        regions: ['East US','East US 2','West US','West US 2','West US 3','Central US','North Central US','South Central US','North Europe','West Europe','UK South','UK West','France Central','Germany West Central','Switzerland North','Norway East','Sweden Central','Canada Central','Canada East','Brazil South','Australia East','Australia Southeast','Japan East','Japan West','Korea Central','Southeast Asia','East Asia','Central India','UAE North','South Africa North']
    },
    {
        id: 'SQL', label: 'SQL', category: 'data',
        score: 3477, params: 3477, resourceTypes: 58, skus: 1185, operations: 678, products: 21,
        desc: 'SQL Database, Elastic Pools, Managed Instance, Hyperscale, Failover Groups',
        regions: ['East US','East US 2','West US','West US 2','West US 3','Central US','North Central US','South Central US','North Europe','West Europe','UK South','UK West','France Central','Germany West Central','Switzerland North','Norway East','Sweden Central','Canada Central','Canada East','Brazil South','Australia East','Australia Southeast','Japan East','Japan West','Korea Central','Southeast Asia','East Asia','Central India','UAE North','South Africa North','Qatar Central']
    },
    {
        id: 'ContainerService', label: 'Kubernetes\nService (AKS)', category: 'compute',
        score: 867, params: 867, resourceTypes: 16, skus: 0, operations: 88, products: 14,
        desc: 'AKS Clusters, Node Pools, Fleet Manager, Extensions, Workload Identity',
        regions: ['East US','East US 2','West US','West US 2','West US 3','Central US','North Central US','South Central US','North Europe','West Europe','UK South','France Central','Germany West Central','Switzerland North','Norway East','Sweden Central','Canada Central','Canada East','Brazil South','Australia East','Japan East','Korea Central','Southeast Asia','East Asia','Central India','UAE North','South Africa North']
    },
    {
        id: 'Web', label: 'Web', category: 'app',
        score: 5914, params: 2746, resourceTypes: 78, skus: 24, operations: 666, products: 12,
        desc: 'App Service, Functions, Static Web Apps, App Service Environments',
        regions: ['East US','East US 2','West US','West US 2','West US 3','Central US','North Central US','South Central US','North Europe','West Europe','UK South','UK West','France Central','Germany West Central','Switzerland North','Norway East','Sweden Central','Canada Central','Canada East','Brazil South','Australia East','Australia Southeast','Japan East','Japan West','Korea Central','Southeast Asia','East Asia','Central India','UAE North','South Africa North']
    },
    {
        id: 'Insights', label: 'Azure\nMonitor', category: 'monitoring',
        score: 1070, params: 1070, resourceTypes: 30, skus: 0, operations: 265, products: 16,
        desc: 'Metrics, Alerts, App Insights, Autoscale, Diagnostic Settings, Workbooks',
        regions: ['East US','East US 2','West US','West US 2','West US 3','Central US','North Central US','South Central US','North Europe','West Europe','UK South','UK West','France Central','Germany West Central','Switzerland North','Norway East','Sweden Central','Canada Central','Canada East','Brazil South','Australia East','Australia Southeast','Japan East','Japan West','Korea Central','Southeast Asia','East Asia','Central India','UAE North','South Africa North','Global']
    },
    {
        id: 'Security', label: 'Defender\nfor Cloud', category: 'security',
        score: 621, params: 621, resourceTypes: 55, skus: 0, operations: 396, products: 24,
        desc: 'Defender Plans, Secure Score, Compliance, JIT Access, DevOps Security',
        regions: ['East US','East US 2','West US','West US 2','Central US','North Central US','South Central US','North Europe','West Europe','UK South','France Central','Germany West Central','Switzerland North','Norway East','Sweden Central','Canada Central','Brazil South','Australia East','Japan East','Korea Central','Southeast Asia','East Asia','Central India','UAE North','South Africa North','Global']
    },
    {
        id: 'Authorization', label: 'Authorization', category: 'security',
        score: 273, params: 273, resourceTypes: 50, skus: 0, operations: 138, products: 14,
        desc: 'RBAC, Azure Policy, Locks, PIM, Access Reviews, Conditions',
        regions: ['Global']
    },
];

const edges = [
    ['Compute','Network',1.0],['Compute','Storage',0.8],['Compute','KeyVault',0.6],
    ['Compute','Insights',0.7],['Compute','Security',0.5],['Compute','Authorization',0.4],
    ['ContainerService','Network',0.9],['ContainerService','Compute',0.7],
    ['ContainerService','Insights',0.6],['ContainerService','KeyVault',0.5],
    ['ContainerService','Storage',0.4],['ContainerService','Authorization',0.4],
    ['Web','Network',0.7],['Web','Storage',0.5],['Web','KeyVault',0.6],
    ['Web','Insights',0.8],['Web','SQL',0.7],['Web','Security',0.4],
    ['SQL','Network',0.6],['SQL','KeyVault',0.7],['SQL','Insights',0.5],
    ['SQL','Security',0.5],['SQL','Storage',0.4],
    ['Storage','Network',0.6],['Storage','KeyVault',0.7],['Storage','Insights',0.5],
    ['KeyVault','Insights',0.4],['KeyVault','Authorization',0.5],
    ['Security','Insights',0.6],['Security','Authorization',0.7],['Security','Network',0.5],
    ['Authorization','Insights',0.4],['Network','Insights',0.6],
];

// ============================================================
// FILTER STATE
// ============================================================
let activeCategories = new Set(Object.keys(CATEGORIES));
let activeRegions = new Set();

// Collect all unique regions
const allRegions = [...new Set(nodes.flatMap(n => n.regions))].sort();
allRegions.forEach(r => activeRegions.add(r));

function isNodeVisible(n) {
    if (!activeCategories.has(n.category)) return false;
    if (activeRegions.size === allRegions.length) return true; // all selected = no filter
    return n.regions.some(r => activeRegions.has(r));
}

// ============================================================
// BUILD FILTER UI
// ============================================================
function buildCategoryFilters() {
    const container = document.getElementById('cat-filters');
    // Keep h3
    const h3 = container.querySelector('h3');
    container.innerHTML = '';
    container.appendChild(h3);

    Object.entries(CATEGORIES).forEach(([key, cat]) => {
        const item = document.createElement('div');
        item.className = 'filter-item active';
        item.dataset.cat = key;
        item.innerHTML = `<div class="filter-cb"></div><div class="cat-dot" style="background:${cat.color};box-shadow:0 0 4px ${cat.glow}"></div><span>${cat.label}</span>`;
        item.addEventListener('click', () => {
            if (activeCategories.has(key)) {
                activeCategories.delete(key);
                item.classList.remove('active');
                item.classList.add('dimmed');
            } else {
                activeCategories.add(key);
                item.classList.add('active');
                item.classList.remove('dimmed');
            }
            updateVisibility();
        });
        container.appendChild(item);
    });
    updateCatCount();
}

function buildRegionFilters(filter = '') {
    const container = document.getElementById('region-list');
    container.innerHTML = '';
    const lf = filter.toLowerCase();
    const filtered = lf ? allRegions.filter(r => r.toLowerCase().includes(lf)) : allRegions;

    filtered.forEach(region => {
        const item = document.createElement('div');
        const isActive = activeRegions.has(region);
        item.className = 'filter-item' + (isActive ? ' active' : ' dimmed');
        item.dataset.region = region;
        item.innerHTML = `<div class="filter-cb"></div><span>${region}</span>`;
        item.addEventListener('click', () => {
            if (activeRegions.has(region)) {
                activeRegions.delete(region);
                item.classList.remove('active');
                item.classList.add('dimmed');
            } else {
                activeRegions.add(region);
                item.classList.add('active');
                item.classList.remove('dimmed');
            }
            updateVisibility();
        });
        container.appendChild(item);
    });
    updateRegionCount();
}

function updateCatCount() {
    document.getElementById('cat-count').textContent = `${activeCategories.size}/${Object.keys(CATEGORIES).length}`;
}
function updateRegionCount() {
    document.getElementById('region-count').textContent = `${activeRegions.size}/${allRegions.length}`;
}

function updateVisibility() {
    nodes.forEach(n => { n.visible = isNodeVisible(n); });
    updateCatCount();
    updateRegionCount();
}

document.getElementById('region-search').addEventListener('input', e => {
    buildRegionFilters(e.target.value);
});

document.getElementById('regions-all').addEventListener('click', () => {
    activeRegions = new Set(allRegions);
    buildRegionFilters(document.getElementById('region-search').value);
    updateVisibility();
});
document.getElementById('regions-none').addEventListener('click', () => {
    activeRegions.clear();
    buildRegionFilters(document.getElementById('region-search').value);
    updateVisibility();
});

buildCategoryFilters();
buildRegionFilters();
nodes.forEach(n => { n.visible = true; });

// ============================================================
// GRAPH ENGINE
// ============================================================
const canvas = document.getElementById('graph');
const ctx = canvas.getContext('2d');
const tooltip = document.getElementById('tooltip');
const panelWidth = 260;

let W, H, dpr;
let frozen = false;
let dragging = null;
let hovering = null;
let panX = 0, panY = 0, zoom = 1;
let lastMouse = { x: 0, y: 0 };
let isPanning = false;

function resize() {
    dpr = window.devicePixelRatio || 1;
    W = window.innerWidth - panelWidth;
    H = window.innerHeight;
    canvas.width = W * dpr;
    canvas.height = H * dpr;
    canvas.style.width = W + 'px';
    canvas.style.height = H + 'px';
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}
window.addEventListener('resize', resize);
resize();

// Initialize positions
const maxScore = Math.max(...nodes.map(n => n.score));
nodes.forEach((n, i) => {
    const angle = (i / nodes.length) * Math.PI * 2 - Math.PI / 2;
    const r = Math.min(W, H) * 0.25;
    n.x = W / 2 + Math.cos(angle) * r;
    n.y = H / 2 + Math.sin(angle) * r;
    n.vx = 0;
    n.vy = 0;
    n.radius = 22 + (n.score / maxScore) * 36;
});

const edgeData = edges.map(([src, tgt, strength]) => ({
    source: nodes.find(n => n.id === src),
    target: nodes.find(n => n.id === tgt),
    strength
}));

// Physics
function simulate() {
    if (frozen) return;
    const centerX = W / 2, centerY = H / 2;
    const damping = 0.88, dt = 0.6;
    const visNodes = nodes.filter(n => n.visible);

    for (let i = 0; i < visNodes.length; i++) {
        for (let j = i + 1; j < visNodes.length; j++) {
            const a = visNodes[i], b = visNodes[j];
            let dx = b.x - a.x, dy = b.y - a.y;
            let dist = Math.sqrt(dx * dx + dy * dy) || 1;
            const force = 32000 / (dist * dist);
            const fx = (dx / dist) * force, fy = (dy / dist) * force;
            a.vx -= fx * dt; a.vy -= fy * dt;
            b.vx += fx * dt; b.vy += fy * dt;
        }
    }

    edgeData.forEach(e => {
        if (!e.source.visible || !e.target.visible) return;
        const dx = e.target.x - e.source.x, dy = e.target.y - e.source.y;
        const dist = Math.sqrt(dx * dx + dy * dy) || 1;
        const idealDist = 200 + (1 - e.strength) * 120;
        const force = (dist - idealDist) * 0.005 * e.strength;
        const fx = (dx / dist) * force, fy = (dy / dist) * force;
        e.source.vx += fx * dt; e.source.vy += fy * dt;
        e.target.vx -= fx * dt; e.target.vy -= fy * dt;
    });

    visNodes.forEach(n => {
        if (n === dragging) return;
        n.vx += (centerX - n.x) * 0.0004 * dt;
        n.vy += (centerY - n.y) * 0.0004 * dt;
        n.vx *= damping; n.vy *= damping;
        n.x += n.vx; n.y += n.vy;
    });
}

// Drawing
function draw() {
    ctx.clearRect(0, 0, W, H);
    ctx.save();
    ctx.translate(panX, panY);
    ctx.scale(zoom, zoom);

    // Edges
    edgeData.forEach(e => {
        if (!e.source.visible || !e.target.visible) return;
        const isHovered = hovering && (e.source === hovering || e.target === hovering);
        const alpha = isHovered ? 0.6 : (hovering ? 0.05 : 0.12 + e.strength * 0.2);
        const width = 1 + e.strength * 2.5;
        ctx.beginPath();
        ctx.moveTo(e.source.x, e.source.y);
        ctx.lineTo(e.target.x, e.target.y);
        ctx.strokeStyle = isHovered ? `rgba(80,230,255,${alpha})` : `rgba(59,158,255,${alpha})`;
        ctx.lineWidth = isHovered ? width + 1 : width;
        ctx.stroke();
        if (isHovered) {
            ctx.shadowColor = 'rgba(80,230,255,0.3)'; ctx.shadowBlur = 8;
            ctx.stroke(); ctx.shadowBlur = 0;
        }
    });

    // Nodes
    nodes.forEach(n => {
        if (!n.visible) return;
        const cat = CATEGORIES[n.category];
        const isHovered = n === hovering;
        const isConnected = hovering && edgeData.some(e =>
            (e.source === hovering && e.target === n) || (e.target === hovering && e.source === n)
        );
        const dimmed = hovering && !isHovered && !isConnected;

        // Glow
        if (isHovered) {
            ctx.save();
            ctx.shadowColor = cat.glow; ctx.shadowBlur = 35;
            ctx.beginPath(); ctx.arc(n.x, n.y, n.radius + 4, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(0,0,0,0)'; ctx.fill();
            ctx.restore();
        }

        // Circle
        const grad = ctx.createRadialGradient(
            n.x - n.radius * 0.3, n.y - n.radius * 0.3, n.radius * 0.1,
            n.x, n.y, n.radius
        );
        const ba = dimmed ? 0.15 : 1;
        grad.addColorStop(0, adjustAlpha(lighten(cat.color, 40), ba));
        grad.addColorStop(1, adjustAlpha(cat.color, ba * 0.7));
        ctx.beginPath(); ctx.arc(n.x, n.y, n.radius, 0, Math.PI * 2);
        ctx.fillStyle = grad; ctx.fill();
        ctx.strokeStyle = adjustAlpha(isHovered ? '#ffffff' : cat.color, dimmed ? 0.08 : 0.5);
        ctx.lineWidth = isHovered ? 2.5 : 1.5; ctx.stroke();

        // Label â€” clipped to circle
        ctx.save();
        ctx.beginPath(); ctx.arc(n.x, n.y, n.radius - 3, 0, Math.PI * 2); ctx.clip();

        const fillAlpha = dimmed ? 'rgba(255,255,255,0.08)' : 'rgba(255,255,255,0.95)';
        ctx.fillStyle = fillAlpha;
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        if (isHovered) { ctx.shadowColor = 'rgba(255,255,255,0.4)'; ctx.shadowBlur = 6; }

        // Split label by explicit \n or auto-wrap
        const lines = n.label.split('\n');
        // Find max font size that fits
        let fontSize = Math.max(9, Math.min(14, n.radius * 0.38));
        ctx.font = `600 ${fontSize}px 'Segoe UI', sans-serif`;

        // Check each line fits within the chord at its y position
        const lineHeight = fontSize * 1.2;
        const totalHeight = lines.length * lineHeight;
        const startY = n.y - (totalHeight / 2) + lineHeight / 2;

        // Shrink font until all lines fit
        for (let attempt = 0; attempt < 8; attempt++) {
            ctx.font = `600 ${fontSize}px 'Segoe UI', sans-serif`;
            let allFit = true;
            for (let li = 0; li < lines.length; li++) {
                const ly = startY + li * lineHeight - n.y; // offset from center
                const chordHalf = Math.sqrt(Math.max(0, (n.radius - 4) * (n.radius - 4) - ly * ly));
                if (ctx.measureText(lines[li]).width > chordHalf * 2 - 4) {
                    allFit = false; break;
                }
            }
            if (allFit) break;
            fontSize -= 0.5;
        }
        ctx.font = `600 ${fontSize}px 'Segoe UI', sans-serif`;

        const lh2 = fontSize * 1.2;
        const th2 = lines.length * lh2;
        const sy2 = n.y - (th2 / 2) + lh2 / 2;
        lines.forEach((line, li) => {
            ctx.fillText(line, n.x, sy2 + li * lh2);
        });

        ctx.shadowBlur = 0;
        ctx.restore(); // un-clip
    });

    ctx.restore();
}

function adjustAlpha(hex, a) {
    const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
    return `rgba(${r},${g},${b},${a})`;
}
function lighten(hex, p) {
    let r = Math.min(255, parseInt(hex.slice(1,3),16)+p);
    let g = Math.min(255, parseInt(hex.slice(3,5),16)+p);
    let b = Math.min(255, parseInt(hex.slice(5,7),16)+p);
    return '#'+r.toString(16).padStart(2,'0')+g.toString(16).padStart(2,'0')+b.toString(16).padStart(2,'0');
}

// ============================================================
// INTERACTION
// ============================================================
function screenToWorld(sx, sy) {
    return { x: (sx - panelWidth - panX) / zoom, y: (sy - panY) / zoom };
}
function nodeAt(sx, sy) {
    const { x, y } = screenToWorld(sx, sy);
    for (let i = nodes.length - 1; i >= 0; i--) {
        const n = nodes[i];
        if (!n.visible) continue;
        const dx = n.x - x, dy = n.y - y;
        if (dx*dx + dy*dy < n.radius * n.radius) return n;
    }
    return null;
}

canvas.addEventListener('mousedown', e => {
    const n = nodeAt(e.clientX, e.clientY);
    if (n) { dragging = n; canvas.style.cursor = 'grabbing'; }
    else { isPanning = true; lastMouse = {x:e.clientX,y:e.clientY}; canvas.style.cursor = 'grabbing'; }
});

canvas.addEventListener('mousemove', e => {
    if (dragging) {
        const {x,y} = screenToWorld(e.clientX, e.clientY);
        dragging.x = x; dragging.y = y; dragging.vx = 0; dragging.vy = 0;
    } else if (isPanning) {
        panX += e.clientX - lastMouse.x; panY += e.clientY - lastMouse.y;
        lastMouse = {x:e.clientX,y:e.clientY};
    } else {
        const n = nodeAt(e.clientX, e.clientY);
        hovering = n;
        canvas.style.cursor = n ? 'pointer' : 'grab';
        if (n) {
            const conns = edgeData
                .filter(ed => (ed.source === n || ed.target === n) && ed.source.visible && ed.target.visible)
                .map(ed => (ed.source === n ? ed.target : ed.source).label.replace(/\n/g,' '));
            const regionCount = n.regions.length;
            const regionSample = n.regions.slice(0,6).join(', ') + (regionCount > 6 ? ` +${regionCount-6} more` : '');

            tooltip.style.display = 'block';
            tooltip.style.left = (e.clientX + 16) + 'px';
            tooltip.style.top = (e.clientY - 10) + 'px';
            tooltip.innerHTML = `
                <h3>${n.label.replace(/\n/g,' ')}</h3>
                <div class="tt-type">${n.desc}</div>
                <div class="tt-stat"><span class="tt-label">Config Parameters</span><span class="tt-value">${n.params.toLocaleString()}</span></div>
                <div class="tt-stat"><span class="tt-label">Resource Types</span><span class="tt-value">${n.resourceTypes}</span></div>
                <div class="tt-stat"><span class="tt-label">SKU Variants</span><span class="tt-value">${n.skus.toLocaleString()}</span></div>
                <div class="tt-stat"><span class="tt-label">API Operations</span><span class="tt-value">${n.operations}</span></div>
                <div class="tt-stat"><span class="tt-label">Products</span><span class="tt-value">${n.products}</span></div>
                <div class="tt-stat"><span class="tt-label">Connections</span><span class="tt-value">${conns.length} (${conns.join(', ')})</span></div>
                <div class="tt-regions"><strong>${regionCount} regions:</strong> ${regionSample}</div>
            `;
            const rect = tooltip.getBoundingClientRect();
            if (rect.right > window.innerWidth) tooltip.style.left = (e.clientX - rect.width - 16) + 'px';
            if (rect.bottom > window.innerHeight) tooltip.style.top = (e.clientY - rect.height - 10) + 'px';
        } else {
            tooltip.style.display = 'none';
        }
    }
});

canvas.addEventListener('mouseup', () => { dragging = null; isPanning = false; canvas.style.cursor = 'grab'; });
canvas.addEventListener('mouseleave', () => { dragging = null; isPanning = false; hovering = null; tooltip.style.display = 'none'; });
canvas.addEventListener('wheel', e => {
    e.preventDefault();
    const f = e.deltaY > 0 ? 0.92 : 1.08;
    const wx = (e.clientX - panelWidth - panX) / zoom;
    const wy = (e.clientY - panY) / zoom;
    zoom = Math.max(0.2, Math.min(5, zoom * f));
    panX = e.clientX - panelWidth - wx * zoom;
    panY = e.clientY - wy * zoom;
}, { passive: false });

document.getElementById('btn-reset').addEventListener('click', () => {
    panX = 0; panY = 0; zoom = 1;
    nodes.forEach((n, i) => {
        const angle = (i / nodes.length) * Math.PI * 2 - Math.PI / 2;
        const r = Math.min(W, H) * 0.25;
        n.x = W/2 + Math.cos(angle)*r; n.y = H/2 + Math.sin(angle)*r;
        n.vx = 0; n.vy = 0;
    });
    frozen = false;
    document.getElementById('btn-freeze').textContent = 'Freeze';
});

document.getElementById('btn-freeze').addEventListener('click', () => {
    frozen = !frozen;
    document.getElementById('btn-freeze').textContent = frozen ? 'Unfreeze' : 'Freeze';
});

// Animation loop
function loop() { simulate(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>
