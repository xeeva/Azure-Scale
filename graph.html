<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Azure Resource Relationship Graph</title>
<style>
:root {
    --bg-primary: #0a0e1a;
    --bg-card: #1a2035;
    --bg-elevated: #1e2a42;
    --border: #1e2d4a;
    --border-glow: #0d4f8b;
    --text: #e2e8f0;
    --text-muted: #8892a8;
    --text-bright: #f1f5f9;
    --neon-cyan: #22d3ee;
    --neon-blue: #60a5fa;
    --neon-purple: #a78bfa;
    --neon-pink: #f472b6;
    --neon-green: #34d399;
    --neon-orange: #fb923c;
    --azure-blue: #3b9eff;
    --panel-width: 280px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
    font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg-primary);
    color: var(--text);
    overflow: hidden;
    height: 100vh;
}

.header {
    position: fixed;
    top: 0; left: var(--panel-width); right: 0;
    z-index: 10;
    background: rgba(10, 14, 26, 0.9);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    padding: 0.75rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.header h1 {
    font-size: 1.15rem;
    font-weight: 600;
    color: var(--neon-blue);
    text-shadow: 0 0 15px rgba(96,165,250,0.3);
}
.header .subtitle {
    font-size: 0.78rem;
    color: var(--text-muted);
    margin-top: 0.1rem;
}
.header-right {
    display: flex;
    gap: 0.6rem;
    align-items: center;
}
.btn {
    background: rgba(59,158,255,0.12);
    border: 1px solid rgba(59,158,255,0.3);
    color: var(--neon-cyan);
    padding: 0.3rem 0.65rem;
    border-radius: 6px;
    font-size: 0.75rem;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.2s;
}
.btn:hover {
    background: rgba(59,158,255,0.25);
    box-shadow: 0 0 12px rgba(34,211,238,0.2);
}
.btn.active {
    background: rgba(34,211,238,0.2);
    border-color: var(--neon-cyan);
}
.back-link {
    color: var(--azure-blue);
    text-decoration: none;
    font-size: 0.78rem;
    transition: color 0.2s, text-shadow 0.2s;
}
.back-link:hover {
    color: var(--neon-cyan);
    text-shadow: 0 0 8px rgba(34,211,238,0.3);
}

/* Left filter panel */
.filter-panel {
    position: fixed;
    top: 0; left: 0; bottom: 0;
    width: var(--panel-width);
    background: rgba(16, 20, 35, 0.97);
    backdrop-filter: blur(12px);
    border-right: 1px solid var(--border);
    z-index: 15;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}
.panel-header {
    padding: 1rem 1.25rem 0.75rem;
    border-bottom: 1px solid var(--border);
}
.panel-header h2 {
    font-size: 0.95rem;
    color: var(--neon-blue);
    text-shadow: 0 0 10px rgba(96,165,250,0.2);
    margin-bottom: 0.15rem;
}
.panel-header p {
    font-size: 0.72rem;
    color: var(--text-muted);
}
.panel-body {
    flex: 1;
    overflow-y: auto;
    padding: 0.75rem 1rem;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
}
.panel-body::-webkit-scrollbar { width: 5px; }
.panel-body::-webkit-scrollbar-track { background: transparent; }
.panel-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

.filter-group {
    margin-bottom: 1.25rem;
}
.filter-group h3 {
    font-size: 0.72rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.filter-group h3 .count {
    color: var(--neon-cyan);
    font-size: 0.68rem;
    text-shadow: 0 0 6px rgba(34,211,238,0.2);
}
.filter-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.3rem 0.4rem;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.15s;
    font-size: 0.78rem;
    color: var(--text);
    user-select: none;
}
.filter-item:hover { background: rgba(59,158,255,0.08); }
.filter-item.dimmed { opacity: 0.35; }

.filter-cb {
    width: 14px;
    height: 14px;
    border: 1.5px solid var(--text-muted);
    border-radius: 3px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
}
.filter-item.active .filter-cb {
    border-color: var(--neon-cyan);
    background: rgba(34,211,238,0.15);
}
.filter-item.active .filter-cb::after {
    content: '';
    width: 7px;
    height: 7px;
    border-radius: 1.5px;
    background: var(--neon-cyan);
    box-shadow: 0 0 4px rgba(34,211,238,0.5);
}
.cat-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}

.filter-actions {
    display: flex;
    gap: 0.4rem;
    margin-top: 0.35rem;
}
.filter-link {
    font-size: 0.68rem;
    color: var(--azure-blue);
    cursor: pointer;
    transition: color 0.2s;
    background: none;
    border: none;
    font-family: inherit;
    padding: 0;
}
.filter-link:hover { color: var(--neon-cyan); }

.region-search {
    width: 100%;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 5px;
    color: var(--text);
    font-family: inherit;
    font-size: 0.75rem;
    padding: 0.35rem 0.5rem;
    margin-bottom: 0.5rem;
    outline: none;
    transition: border-color 0.2s;
}
.region-search:focus { border-color: var(--azure-blue); }
.region-search::placeholder { color: var(--text-muted); opacity: 0.5; }

/* Toggle switch */
.toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.35rem 0.4rem;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.15s;
}
.toggle-row:hover { background: rgba(59,158,255,0.08); }
.toggle-label {
    font-size: 0.78rem;
    color: var(--text);
}
.toggle-switch {
    width: 36px;
    height: 20px;
    background: var(--border);
    border-radius: 10px;
    position: relative;
    transition: background 0.2s, box-shadow 0.2s;
    flex-shrink: 0;
}
.toggle-switch.on {
    background: var(--neon-cyan);
    box-shadow: 0 0 8px rgba(34,211,238,0.3);
}
.toggle-switch::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    background: white;
    border-radius: 50%;
    top: 2px;
    left: 2px;
    transition: transform 0.2s;
}
.toggle-switch.on::after {
    transform: translateX(16px);
}
.sub-stats {
    font-size: 0.68rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
    padding: 0 0.4rem;
}

/* Legend */
.panel-legend {
    padding: 0.75rem 1rem;
    border-top: 1px solid var(--border);
    font-size: 0.68rem;
}
.panel-legend .legend-item {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    margin-bottom: 0.25rem;
    color: var(--text-muted);
}
.legend-line-thick {
    width: 16px; height: 3px; background: rgba(59,158,255,0.5); border-radius: 1px; flex-shrink: 0;
}
.legend-line-thin {
    width: 16px; height: 1px; background: rgba(59,158,255,0.25); flex-shrink: 0;
}
.legend-line-dashed {
    width: 16px; height: 0; border-top: 1px dashed rgba(167,139,250,0.5); flex-shrink: 0;
}
.legend-node-big {
    width: 12px; height: 12px; border-radius: 50%; background: rgba(59,158,255,0.5); flex-shrink: 0;
}
.legend-node-small {
    width: 7px; height: 7px; border-radius: 50%; background: rgba(59,158,255,0.35); flex-shrink: 0; margin: 0 2.5px;
}

canvas {
    position: fixed;
    top: 0; left: var(--panel-width); right: 0; bottom: 0;
    display: block;
    cursor: grab;
}
canvas:active { cursor: grabbing; }

.tooltip {
    position: fixed;
    display: none;
    background: rgba(26, 32, 53, 0.95);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    font-size: 0.82rem;
    max-width: 340px;
    pointer-events: none;
    z-index: 20;
    box-shadow: 0 4px 24px rgba(0,0,0,0.4), 0 0 20px rgba(59,158,255,0.08);
}
.tooltip h3 {
    color: var(--neon-cyan);
    font-size: 0.9rem;
    margin-bottom: 0.35rem;
    text-shadow: 0 0 8px rgba(34,211,238,0.3);
}
.tooltip .tt-type {
    color: var(--text-muted);
    font-size: 0.75rem;
    margin-bottom: 0.5rem;
}
.tooltip .tt-stat {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    padding: 0.15rem 0;
    border-bottom: 1px solid rgba(255,255,255,0.04);
}
.tooltip .tt-stat:last-child { border-bottom: none; }
.tooltip .tt-label { color: var(--text-muted); }
.tooltip .tt-value { color: var(--text-bright); font-weight: 600; }
.tooltip .tt-regions {
    margin-top: 0.4rem;
    padding-top: 0.4rem;
    border-top: 1px solid rgba(255,255,255,0.06);
    font-size: 0.72rem;
    color: var(--text-muted);
    line-height: 1.4;
}
.tooltip .tt-regions strong { color: var(--neon-blue); }

/* Right detail panel */
.detail-panel {
    position: fixed;
    top: 0; right: 0; bottom: 0;
    width: 340px;
    background: rgba(16, 20, 35, 0.97);
    backdrop-filter: blur(12px);
    border-left: 1px solid var(--border);
    z-index: 15;
    display: flex;
    flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    overflow: hidden;
}
.detail-panel.open { transform: translateX(0); }
.detail-header {
    padding: 1rem 1.25rem 0.75rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 0.75rem;
}
.detail-title { display: flex; align-items: center; gap: 0.5rem; flex: 1; min-width: 0; }
.detail-title h2 {
    font-size: 1.05rem; color: var(--neon-cyan);
    text-shadow: 0 0 12px rgba(34,211,238,0.3); word-break: break-word;
}
.detail-cat-badge {
    font-size: 0.62rem; padding: 0.15rem 0.5rem; border-radius: 10px;
    font-weight: 600; white-space: nowrap; display: inline-block; margin-top: 0.2rem;
}
.detail-close {
    background: none; border: none; color: var(--text-muted); font-size: 1.5rem;
    cursor: pointer; padding: 0; line-height: 1; transition: color 0.2s; flex-shrink: 0;
}
.detail-close:hover { color: var(--neon-cyan); }
.detail-body {
    flex: 1; overflow-y: auto; padding: 0;
    scrollbar-width: thin; scrollbar-color: var(--border) transparent;
}
.detail-body::-webkit-scrollbar { width: 5px; }
.detail-body::-webkit-scrollbar-track { background: transparent; }
.detail-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
.detail-desc {
    padding: 0.75rem 1.25rem; font-size: 0.8rem;
    color: var(--text-muted); line-height: 1.5; border-bottom: 1px solid var(--border);
}
.detail-section {
    padding: 0.75rem 1.25rem; border-bottom: 1px solid var(--border);
}
.detail-section h3 {
    font-size: 0.72rem; font-weight: 600; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 0.5rem;
    display: flex; justify-content: space-between; align-items: center;
}
.detail-section h3 .ds-count {
    color: var(--neon-cyan); font-size: 0.68rem;
    text-shadow: 0 0 6px rgba(34,211,238,0.2);
}
.detail-stat-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;
}
.detail-stat-card {
    background: rgba(30,42,66,0.5); border: 1px solid rgba(30,45,74,0.5);
    border-radius: 6px; padding: 0.5rem 0.65rem;
}
.detail-stat-card .ds-value {
    font-size: 1rem; font-weight: 700; color: var(--neon-cyan);
    text-shadow: 0 0 8px rgba(34,211,238,0.2);
}
.detail-stat-card .ds-label {
    font-size: 0.65rem; color: var(--text-muted); margin-top: 0.1rem;
}
.dli {
    display: block; padding: 0.4rem; border-radius: 5px;
    cursor: pointer; transition: background 0.15s; margin-bottom: 0.1rem;
}
.dli:hover { background: rgba(59,158,255,0.1); }
.dli-row {
    display: flex; align-items: center; gap: 0.5rem; font-size: 0.78rem; color: var(--text);
}
.dli-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.dli-name { flex: 1; min-width: 0; }
.dli-meta { font-size: 0.68rem; color: var(--text-muted); flex-shrink: 0; }
.dli-desc {
    font-size: 0.67rem; color: var(--text-muted); margin-top: 0.15rem;
    padding-left: 1.1rem; line-height: 1.35;
}
.strength-bar { display: flex; gap: 2px; flex-shrink: 0; }
.strength-bar span {
    width: 4px; height: 4px; border-radius: 50%; background: var(--border);
}
.strength-bar span.on {
    background: var(--neon-cyan); box-shadow: 0 0 3px rgba(34,211,238,0.4);
}
.detail-regions {
    padding: 0.75rem 1.25rem; font-size: 0.72rem;
    color: var(--text-muted); line-height: 1.5;
}
.detail-regions strong { color: var(--neon-blue); }
.detail-regions .region-tags {
    display: flex; flex-wrap: wrap; gap: 0.25rem; margin-top: 0.35rem;
}
.region-tag {
    font-size: 0.62rem; padding: 0.1rem 0.4rem; border-radius: 3px;
    background: rgba(30,42,66,0.6); border: 1px solid rgba(30,45,74,0.4);
    color: var(--text-muted);
}
</style>
</head>
<body>

<div class="filter-panel">
    <div class="panel-header">
        <h2>Filters</h2>
        <p>Filter by category, depth, or region availability</p>
    </div>
    <div class="panel-body">
        <div class="filter-group" id="cat-filters">
            <h3>Categories <span class="count" id="cat-count"></span></h3>
        </div>

        <div class="filter-group">
            <h3>Display</h3>
            <div class="toggle-row" id="toggle-row-subs">
                <span class="toggle-label">Sub-Services</span>
                <div class="toggle-switch on" id="toggle-subs"></div>
            </div>
            <div class="sub-stats" id="sub-stats"></div>
        </div>

        <div class="filter-group" id="region-filters">
            <h3>Regions <span class="count" id="region-count"></span></h3>
            <input type="text" class="region-search" id="region-search" placeholder="Search regions...">
            <div class="filter-actions">
                <button class="filter-link" id="regions-all">Select All</button>
                <button class="filter-link" id="regions-none">Clear All</button>
            </div>
            <div id="region-list" style="margin-top:0.4rem"></div>
        </div>
    </div>
    <div class="panel-legend">
        <div class="legend-item"><div class="legend-node-big"></div> Resource provider</div>
        <div class="legend-item"><div class="legend-node-small"></div> Sub-service / product</div>
        <div class="legend-item"><div class="legend-line-thick"></div> Provider dependency</div>
        <div class="legend-item"><div class="legend-line-thin"></div> Parent &harr; sub-service</div>
        <div class="legend-item"><div class="legend-line-dashed"></div> Cross-service relationship</div>
        <div style="margin-top:0.3rem;color:#3a4158">Node size = complexity score</div>
    </div>
</div>

<div class="header">
    <div>
        <h1>Azure Resource Relationship Graph</h1>
        <div class="subtitle">Force-directed visualisation of service and sub-service interdependencies</div>
    </div>
    <div class="header-right">
        <button class="btn" id="btn-reset">Reset View</button>
        <button class="btn" id="btn-freeze">Freeze</button>
        <a href="index.html" class="back-link">&larr; Back to Report</a>
    </div>
</div>

<canvas id="graph"></canvas>
<div class="tooltip" id="tooltip"></div>

<div class="detail-panel" id="detail-panel">
    <div class="detail-header">
        <div class="detail-title"><h2 id="detail-name"></h2></div>
        <button class="detail-close" id="detail-close">&times;</button>
    </div>
    <div class="detail-body" id="detail-body"></div>
</div>

<script>
// ============================================================
// DATA — CATEGORIES
// ============================================================
const CATEGORIES = {
    compute:    { color: '#3b9eff', glow: 'rgba(59,158,255,0.5)',   label: 'Compute' },
    networking: { color: '#22d3ee', glow: 'rgba(34,211,238,0.5)',   label: 'Networking' },
    data:       { color: '#a78bfa', glow: 'rgba(167,139,250,0.5)', label: 'Data & Storage' },
    security:   { color: '#f472b6', glow: 'rgba(244,114,182,0.5)', label: 'Security & Identity' },
    app:        { color: '#34d399', glow: 'rgba(52,211,153,0.5)',   label: 'App Platform' },
    monitoring: { color: '#fb923c', glow: 'rgba(251,146,60,0.5)',   label: 'Monitoring & Mgmt' },
};

// ============================================================
// DATA — PARENT NODES (10 resource providers)
// ============================================================
const parentNodes = [
    {
        id: 'Compute', label: 'Compute', category: 'compute', isParent: true,
        score: 1407, params: 1407, resourceTypes: 38, skus: 4635, operations: 418, products: 18,
        desc: 'Virtual Machines, Scale Sets, Managed Disks, Galleries, Dedicated Hosts',
        regions: ['East US','East US 2','West US','West US 2','West US 3','Central US','North Central US','South Central US','West Central US','North Europe','West Europe','UK South','UK West','France Central','Germany West Central','Switzerland North','Norway East','Sweden Central','Poland Central','Italy North','Spain Central','Canada Central','Canada East','Brazil South','Australia East','Australia Southeast','Japan East','Japan West','Korea Central','Southeast Asia','East Asia','Central India','South India','UAE North','South Africa North','Qatar Central']
    },
    {
        id: 'Network', label: 'Network', category: 'networking', isParent: true,
        score: 8549, params: 8549, resourceTypes: 172, skus: 90, operations: 1437, products: 50,
        desc: 'VNets, NSGs, Load Balancers, Firewalls, VPN Gateways, DNS, Front Door',
        regions: ['East US','East US 2','West US','West US 2','West US 3','Central US','North Central US','South Central US','North Europe','West Europe','UK South','UK West','France Central','Germany West Central','Switzerland North','Norway East','Sweden Central','Canada Central','Canada East','Brazil South','Australia East','Australia Southeast','Japan East','Japan West','Korea Central','Southeast Asia','East Asia','Central India','UAE North','South Africa North','Qatar Central','Poland Central','Italy North','Israel Central','Mexico Central']
    },
    {
        id: 'Storage', label: 'Storage', category: 'data', isParent: true,
        score: 1855, params: 1855, resourceTypes: 36, skus: 306, operations: 346, products: 16,
        desc: 'Blob, Files, Queues, Tables, Data Lake Gen2, Immutable Storage',
        regions: ['East US','East US 2','West US','West US 2','West US 3','Central US','North Central US','South Central US','North Europe','West Europe','UK South','UK West','France Central','Germany West Central','Switzerland North','Norway East','Sweden Central','Canada Central','Canada East','Brazil South','Australia East','Australia Southeast','Japan East','Japan West','Korea Central','Southeast Asia','East Asia','Central India','UAE North','South Africa North','Qatar Central','Poland Central','Italy North']
    },
    {
        id: 'KeyVault', label: 'Key Vault', category: 'security', isParent: true,
        score: 418, params: 418, resourceTypes: 10, skus: 0, operations: 155, products: 11,
        desc: 'Keys, Secrets, Certificates, Managed HSM, Access Policies',
        regions: ['East US','East US 2','West US','West US 2','West US 3','Central US','North Central US','South Central US','North Europe','West Europe','UK South','UK West','France Central','Germany West Central','Switzerland North','Norway East','Sweden Central','Canada Central','Canada East','Brazil South','Australia East','Australia Southeast','Japan East','Japan West','Korea Central','Southeast Asia','East Asia','Central India','UAE North','South Africa North']
    },
    {
        id: 'SQL', label: 'SQL', category: 'data', isParent: true,
        score: 3477, params: 3477, resourceTypes: 58, skus: 1185, operations: 678, products: 21,
        desc: 'SQL Database, Elastic Pools, Managed Instance, Hyperscale, Failover Groups',
        regions: ['East US','East US 2','West US','West US 2','West US 3','Central US','North Central US','South Central US','North Europe','West Europe','UK South','UK West','France Central','Germany West Central','Switzerland North','Norway East','Sweden Central','Canada Central','Canada East','Brazil South','Australia East','Australia Southeast','Japan East','Japan West','Korea Central','Southeast Asia','East Asia','Central India','UAE North','South Africa North','Qatar Central']
    },
    {
        id: 'ContainerService', label: 'Kubernetes\nService (AKS)', category: 'compute', isParent: true,
        score: 867, params: 867, resourceTypes: 16, skus: 0, operations: 88, products: 14,
        desc: 'AKS Clusters, Node Pools, Fleet Manager, Extensions, Workload Identity',
        regions: ['East US','East US 2','West US','West US 2','West US 3','Central US','North Central US','South Central US','North Europe','West Europe','UK South','France Central','Germany West Central','Switzerland North','Norway East','Sweden Central','Canada Central','Canada East','Brazil South','Australia East','Japan East','Korea Central','Southeast Asia','East Asia','Central India','UAE North','South Africa North']
    },
    {
        id: 'Web', label: 'Web', category: 'app', isParent: true,
        score: 5914, params: 2746, resourceTypes: 78, skus: 24, operations: 666, products: 12,
        desc: 'App Service, Functions, Static Web Apps, App Service Environments',
        regions: ['East US','East US 2','West US','West US 2','West US 3','Central US','North Central US','South Central US','North Europe','West Europe','UK South','UK West','France Central','Germany West Central','Switzerland North','Norway East','Sweden Central','Canada Central','Canada East','Brazil South','Australia East','Australia Southeast','Japan East','Japan West','Korea Central','Southeast Asia','East Asia','Central India','UAE North','South Africa North']
    },
    {
        id: 'Insights', label: 'Azure\nMonitor', category: 'monitoring', isParent: true,
        score: 1070, params: 1070, resourceTypes: 30, skus: 0, operations: 265, products: 16,
        desc: 'Metrics, Alerts, App Insights, Autoscale, Diagnostic Settings, Workbooks',
        regions: ['East US','East US 2','West US','West US 2','West US 3','Central US','North Central US','South Central US','North Europe','West Europe','UK South','UK West','France Central','Germany West Central','Switzerland North','Norway East','Sweden Central','Canada Central','Canada East','Brazil South','Australia East','Australia Southeast','Japan East','Japan West','Korea Central','Southeast Asia','East Asia','Central India','UAE North','South Africa North','Global']
    },
    {
        id: 'Security', label: 'Defender\nfor Cloud', category: 'security', isParent: true,
        score: 621, params: 621, resourceTypes: 55, skus: 0, operations: 396, products: 24,
        desc: 'Defender Plans, Secure Score, Compliance, JIT Access, DevOps Security',
        regions: ['East US','East US 2','West US','West US 2','Central US','North Central US','South Central US','North Europe','West Europe','UK South','France Central','Germany West Central','Switzerland North','Norway East','Sweden Central','Canada Central','Brazil South','Australia East','Japan East','Korea Central','Southeast Asia','East Asia','Central India','UAE North','South Africa North','Global']
    },
    {
        id: 'Authorization', label: 'Authorization', category: 'security', isParent: true,
        score: 273, params: 273, resourceTypes: 50, skus: 0, operations: 138, products: 14,
        desc: 'RBAC, Azure Policy, Locks, PIM, Access Reviews, Conditions',
        regions: ['Global']
    },
];

// ============================================================
// DATA — SUB-NODE DEFINITIONS [id, label, parentId]
// ============================================================
const SUB_DEFS = [
    // --- Compute (18) ---
    ['compute-vms','Virtual\nMachines','Compute'],
    ['compute-vmss','Scale Sets','Compute'],
    ['compute-disks','Managed\nDisks','Compute'],
    ['compute-des','Disk Encrypt\nSets','Compute'],
    ['compute-snapshots','Snapshots','Compute'],
    ['compute-drp','Disk Restore\nPoints','Compute'],
    ['compute-images','Images','Compute'],
    ['compute-gallery','Compute\nGallery','Compute'],
    ['compute-vmapps','VM Apps','Compute'],
    ['compute-avsets','Availability\nSets','Compute'],
    ['compute-ppg','Proximity\nPlacement','Compute'],
    ['compute-capacity','Capacity\nReservation','Compute'],
    ['compute-hosts','Dedicated\nHosts','Compute'],
    ['compute-sshkeys','SSH Keys','Compute'],
    ['compute-extensions','VM\nExtensions','Compute'],
    ['compute-cloudsvcs','Cloud\nServices','Compute'],
    ['compute-rpc','Restore\nPoints','Compute'],
    ['compute-diskaccess','Disk Access','Compute'],
    // --- Network (49) ---
    ['network-vnet','VNet','Network'],
    ['network-nsg','NSG','Network'],
    ['network-asg','App Security\nGroup','Network'],
    ['network-lb','Load\nBalancer','Network'],
    ['network-appgw','App\nGateway','Network'],
    ['network-waf','WAF','Network'],
    ['network-firewall','Azure\nFirewall','Network'],
    ['network-fwpolicy','Firewall\nPolicy','Network'],
    ['network-bastion','Bastion','Network'],
    ['network-ddos','DDoS\nProtection','Network'],
    ['network-natgw','NAT\nGateway','Network'],
    ['network-pip','Public IP','Network'],
    ['network-pipprefix','IP Prefix','Network'],
    ['network-customip','Custom IP','Network'],
    ['network-nic','NIC','Network'],
    ['network-rt','Route\nTable','Network'],
    ['network-routefilter','Route\nFilter','Network'],
    ['network-vpngw','VPN\nGateway','Network'],
    ['network-lng','Local Net\nGateway','Network'],
    ['network-er','ExpressRoute','Network'],
    ['network-ergw','ER\nGateway','Network'],
    ['network-erport','ER Port','Network'],
    ['network-vwan','Virtual\nWAN','Network'],
    ['network-vwanvpn','vWAN VPN','Network'],
    ['network-p2svpn','P2S VPN','Network'],
    ['network-vpnsite','VPN Site','Network'],
    ['network-vhub','Virtual\nHub','Network'],
    ['network-dns','DNS Zone','Network'],
    ['network-privdns','Private\nDNS','Network'],
    ['network-dnsresolver','DNS\nResolver','Network'],
    ['network-dnspolicy','DNS Policy','Network'],
    ['network-tm','Traffic\nManager','Network'],
    ['network-fd','Front Door','Network'],
    ['network-pe','Private\nEndpoint','Network'],
    ['network-pls','Private Link','Network'],
    ['network-watcher','Network\nWatcher','Network'],
    ['network-connmon','Connection\nMonitor','Network'],
    ['network-flowlogs','Flow Logs','Network'],
    ['network-manager','Network\nManager','Network'],
    ['network-nsp','Security\nPerimeter','Network'],
    ['network-nva','NVA','Network'],
    ['network-dscp','DSCP','Network'],
    ['network-ipgroups','IP Groups','Network'],
    ['network-ipam','IPAM','Network'],
    ['network-sep','Endpoint\nPolicy','Network'],
    ['network-tap','VNet Tap','Network'],
    ['network-vrouter','Route\nServer','Network'],
    ['network-webcats','Web\nCategories','Network'],
    ['network-verifier','Network\nVerifier','Network'],
    // --- Storage (16) ---
    ['storage-accounts','Storage\nAccounts','Storage'],
    ['storage-blob','Blob\nStorage','Storage'],
    ['storage-adls','Data Lake\nGen2','Storage'],
    ['storage-files','Azure\nFiles','Storage'],
    ['storage-queue','Queue\nStorage','Storage'],
    ['storage-table','Table\nStorage','Storage'],
    ['storage-immutable','Immutable\nStorage','Storage'],
    ['storage-versioning','Blob\nVersioning','Storage'],
    ['storage-softdelete','Soft\nDelete','Storage'],
    ['storage-encryption','Encryption\nScopes','Storage'],
    ['storage-replication','Object\nReplication','Storage'],
    ['storage-static','Static\nWebsite','Storage'],
    ['storage-firewall','Storage\nFirewall','Storage'],
    ['storage-pe','Private\nEndpoints','Storage'],
    ['storage-sas','SAS\nTokens','Storage'],
    ['storage-tasks','Storage\nTasks','Storage'],
    // --- Key Vault (11) ---
    ['keyvault-standard','Standard\nVault','KeyVault'],
    ['keyvault-premium','Premium\nVault','KeyVault'],
    ['keyvault-mhsm','Managed\nHSM','KeyVault'],
    ['keyvault-keys','Keys','KeyVault'],
    ['keyvault-secrets','Secrets','KeyVault'],
    ['keyvault-certs','Certificates','KeyVault'],
    ['keyvault-rotation','Key\nRotation','KeyVault'],
    ['keyvault-access','Access\nControl','KeyVault'],
    ['keyvault-softdelete','Soft Delete\n& Purge','KeyVault'],
    ['keyvault-pe','Private\nEndpoints','KeyVault'],
    ['keyvault-backup','Backup\n& Restore','KeyVault'],
    // --- SQL (21) ---
    ['sql-db','SQL\nDatabase','SQL'],
    ['sql-elastic','Elastic\nPool','SQL'],
    ['sql-hyperscale','Hyperscale','SQL'],
    ['sql-mi','Managed\nInstance','SQL'],
    ['sql-mipools','MI Pools','SQL'],
    ['sql-jobs','Elastic\nJobs','SQL'],
    ['sql-failover','Failover\nGroups','SQL'],
    ['sql-georep','Geo\nReplication','SQL'],
    ['sql-ltr','Long-Term\nBackup','SQL'],
    ['sql-pitr','Short-Term\nBackup','SQL'],
    ['sql-tde','TDE','SQL'],
    ['sql-ae','Always\nEncrypted','SQL'],
    ['sql-audit','Auditing','SQL'],
    ['sql-atp','Threat\nProtection','SQL'],
    ['sql-va','Vulnerability\nAssessment','SQL'],
    ['sql-ddm','Dynamic\nMasking','SQL'],
    ['sql-ledger','Ledger','SQL'],
    ['sql-sync','Sync\nGroups','SQL'],
    ['sql-dnsalias','DNS\nAlias','SQL'],
    ['sql-vc','Virtual\nClusters','SQL'],
    ['sql-devops','DevOps\nAudit','SQL'],
    // --- Container Service / AKS (14) ---
    ['aks-cluster','AKS\nCluster','ContainerService'],
    ['aks-syspools','System\nNode Pools','ContainerService'],
    ['aks-userpools','User\nNode Pools','ContainerService'],
    ['aks-vnodes','Virtual\nNodes','ContainerService'],
    ['aks-fleet','Fleet\nManager','ContainerService'],
    ['aks-extensions','Cluster\nExtensions','ContainerService'],
    ['aks-maintenance','Maintenance\nConfig','ContainerService'],
    ['aks-snapshots','Cluster\nSnapshots','ContainerService'],
    ['aks-trustedaccess','Trusted\nAccess','ContainerService'],
    ['aks-netpolicy','Network\nPolicies','ContainerService'],
    ['aks-workloadid','Workload\nIdentity','ContainerService'],
    ['aks-automatic','AKS\nAutomatic','ContainerService'],
    ['aks-imgclean','Image\nCleaner','ContainerService'],
    ['aks-backup','AKS\nBackup','ContainerService'],
    // --- Web (12) ---
    ['web-apps','Web\nApps','Web'],
    ['web-functions','Azure\nFunctions','Web'],
    ['web-plans','App Service\nPlans','Web'],
    ['web-ase','App Service\nEnvironment','Web'],
    ['web-slots','Deployment\nSlots','Web'],
    ['web-certs','App Service\nCerts','Web'],
    ['web-domains','App Service\nDomains','Web'],
    ['web-staticapps','Static\nWeb Apps','Web'],
    ['web-hybrid','Hybrid\nConnections','Web'],
    ['web-webjobs','WebJobs','Web'],
    ['web-managedcerts','Managed\nCerts','Web'],
    ['web-vnetint','VNet\nIntegration','Web'],
    // --- Insights / Monitor (16) ---
    ['insights-metrics','Monitor\nMetrics','Insights'],
    ['insights-alerts','Metric\nAlerts','Insights'],
    ['insights-actlog','Activity\nLog','Insights'],
    ['insights-actlogalerts','Activity\nAlerts','Insights'],
    ['insights-sqr','Scheduled\nQueries','Insights'],
    ['insights-actiongroups','Action\nGroups','Insights'],
    ['insights-autoscale','Autoscale','Insights'],
    ['insights-diagnostic','Diagnostic\nSettings','Insights'],
    ['insights-appinsights','App\nInsights','Insights'],
    ['insights-profiler','Profiler','Insights'],
    ['insights-snapshot','Snapshot\nDebugger','Insights'],
    ['insights-dcr','Data Collection\nRules','Insights'],
    ['insights-dce','Data Collection\nEndpoints','Insights'],
    ['insights-pls','Private Link\nScopes','Insights'],
    ['insights-workbooks','Workbooks','Insights'],
    ['insights-webtests','Web\nTests','Insights'],
    // --- Security / Defender (24) ---
    ['security-servers','Defender\nServers','Security'],
    ['security-appservice','Defender\nApp Service','Security'],
    ['security-sql','Defender\nSQL','Security'],
    ['security-sqlmachines','Defender SQL\nMachines','Security'],
    ['security-opensource','Defender\nOSS DBs','Security'],
    ['security-storage','Defender\nStorage','Security'],
    ['security-containers','Defender\nContainers','Security'],
    ['security-keyvault','Defender\nKey Vault','Security'],
    ['security-dns','Defender\nDNS','Security'],
    ['security-arm','Defender\nARM','Security'],
    ['security-apis','Defender\nAPIs','Security'],
    ['security-cspm','Cloud\nCSPM','Security'],
    ['security-alerts','Security\nAlerts','Security'],
    ['security-assessments','Security\nAssessments','Security'],
    ['security-score','Secure\nScore','Security'],
    ['security-compliance','Regulatory\nCompliance','Security'],
    ['security-jit','JIT VM\nAccess','Security'],
    ['security-appcontrols','App\nControls','Security'],
    ['security-anhr','Network\nHardening','Security'],
    ['security-fim','File Integrity\nMonitoring','Security'],
    ['security-automation','Workflow\nAutomation','Security'],
    ['security-autoprov','Auto\nProvisioning','Security'],
    ['security-multicloud','Multi-Cloud\nConnectors','Security'],
    ['security-devops','DevOps\nSecurity','Security'],
    // --- Authorization (14) ---
    ['auth-rbac','RBAC','Authorization'],
    ['auth-roleassign','Role\nAssignments','Authorization'],
    ['auth-customroles','Custom\nRoles','Authorization'],
    ['auth-policydef','Policy\nDefinitions','Authorization'],
    ['auth-initiatives','Policy\nInitiatives','Authorization'],
    ['auth-assignments','Policy\nAssignments','Authorization'],
    ['auth-remediation','Remediation\nTasks','Authorization'],
    ['auth-exemptions','Policy\nExemptions','Authorization'],
    ['auth-locks','Resource\nLocks','Authorization'],
    ['auth-pim','PIM','Authorization'],
    ['auth-accessreviews','Access\nReviews','Authorization'],
    ['auth-blueprints','Blueprints','Authorization'],
    ['auth-conditions','ABAC\nConditions','Authorization'],
    ['auth-eligible','Eligible\nAssignments','Authorization'],
];

// Sub-node descriptions for detail panel
const SUB_DESCS = {
    'compute-vms':'700+ SKU sizes across general purpose, compute-optimized, memory-optimized, storage, GPU, HPC, and confidential VM families.',
    'compute-vmss':'Uniform and flexible mode scale sets with autoscale, rolling upgrades, and fault domain management.',
    'compute-disks':'Ultra, Premium SSD v2, Premium SSD, Standard SSD, Standard HDD tiers with bursting and shared disk support.',
    'compute-des':'Platform-managed, customer-managed, and double encryption with confidential encryption support.',
    'compute-snapshots':'Incremental and full snapshots with cross-region copy and trusted launch support.',
    'compute-drp':'Crash-consistent and application-consistent disk restore points for disaster recovery.',
    'compute-images':'Generalized and specialized managed images created from VHDs for VM deployment.',
    'compute-gallery':'Shared image galleries with image definitions, versions, community and direct shared galleries.',
    'compute-vmapps':'VM application definitions and versions for custom script and software delivery.',
    'compute-avsets':'Fault domain and update domain grouping for high availability within a datacenter.',
    'compute-ppg':'Low-latency co-location of VMs within the same datacenter proximity zone.',
    'compute-capacity':'Guaranteed compute capacity reservations per SKU for planned workload deployments.',
    'compute-hosts':'Single-tenant physical servers providing hardware isolation for compliance and licensing.',
    'compute-sshkeys':'Centrally managed SSH public keys for Linux VM authentication.',
    'compute-extensions':'Custom Script, DSC, diagnostics, monitoring agents, disk encryption, and more.',
    'compute-cloudsvcs':'Classic PaaS web and worker roles (extended support) for legacy cloud service workloads.',
    'compute-rpc':'VM-level crash-consistent and application-consistent restore point collections.',
    'compute-diskaccess':'Private endpoint access to managed disks bypassing public network exposure.',
    'network-vnet':'Virtual networks with subnets, peering, service endpoints, and VNet integration.',
    'network-nsg':'Inbound and outbound security rules with application security group bindings.',
    'network-asg':'Logical grouping of VM NICs for simplified NSG rule management.',
    'network-lb':'Basic, Standard, and Gateway SKUs with frontend IPs, backend pools, health probes.',
    'network-appgw':'Layer 7 load balancer with URL path routing, SSL termination, and autoscale.',
    'network-waf':'OWASP/CRS rule sets, custom rules, bot protection for App Gateway and Front Door.',
    'network-firewall':'Network rules, application rules, NAT rules, threat intelligence, IDPS, TLS inspection.',
    'network-fwpolicy':'Rule collection groups and collections with IP group associations for firewall management.',
    'network-bastion':'Secure RDP/SSH access without public IPs via Basic, Standard, and Developer SKUs.',
    'network-ddos':'Standard and IP protection plans with automatic attack mitigation and telemetry.',
    'network-natgw':'Outbound SNAT with configurable idle timeout and public IP association.',
    'network-pip':'Basic and Standard SKUs with static/dynamic allocation for IPv4 and IPv6.',
    'network-pipprefix':'Contiguous public IP ranges with bring-your-own-IP (BYOIP) support.',
    'network-customip':'Bring your own IP address ranges to Azure for use with public resources.',
    'network-nic':'IP configurations with accelerated networking and IP forwarding support.',
    'network-rt':'User-defined routes with BGP route propagation and custom next hop types.',
    'network-routefilter':'BGP community filtering for controlling ExpressRoute route advertisements.',
    'network-vpngw':'Site-to-site, point-to-site, VNet-to-VNet with IKEv2, OpenVPN, SSTP protocols.',
    'network-lng':'On-premises VPN device endpoint definition with BGP settings and address spaces.',
    'network-er':'Private and Microsoft peering with Standard/Premium tiers, metered/unlimited billing.',
    'network-ergw':'Standard, High Performance, Ultra Performance gateway SKUs with FastPath support.',
    'network-erport':'ExpressRoute Direct connections at 10 Gbps and 100 Gbps port speeds.',
    'network-vwan':'Hub-and-spoke topology with any-to-any connectivity across branch, VNet, and users.',
    'network-vwanvpn':'Site-to-site VPN connections within the Virtual WAN hub infrastructure.',
    'network-p2svpn':'Point-to-site VPN gateway within Virtual WAN for remote user connectivity.',
    'network-vpnsite':'Branch office connectivity definitions for Virtual WAN site-to-site tunnels.',
    'network-vhub':'Virtual WAN routing, route tables, and security partner provider integration.',
    'network-dns':'Public DNS hosting for A, AAAA, CNAME, MX, NS, SRV, TXT, and other record types.',
    'network-privdns':'Private name resolution within VNets with auto-registration and virtual network links.',
    'network-dnsresolver':'Inbound and outbound endpoints with conditional forwarding rule sets.',
    'network-dnspolicy':'DNS security rules and virtual network link policies for resolver governance.',
    'network-tm':'DNS-based global load balancing with priority, weighted, performance, geographic routing.',
    'network-fd':'Global load balancing, CDN, WAF, SSL offload with Classic, Standard, Premium tiers.',
    'network-pe':'Private connectivity to PaaS services and custom Private Link services over VNet.',
    'network-pls':'Expose your own service to consumers via Private Endpoint across tenants.',
    'network-watcher':'Network topology, packet capture, IP flow verify, next hop, VPN diagnostics.',
    'network-connmon':'End-to-end connectivity monitoring with latency and reachability tracking.',
    'network-flowlogs':'NSG traffic capture with traffic analytics and configurable retention policies.',
    'network-manager':'Centralized connectivity configs and security admin rules with scope management.',
    'network-nsp':'PaaS firewall perimeter with access rules and diagnostic logging.',
    'network-nva':'Orchestrated network virtual appliance deployment with boot diagnostics.',
    'network-dscp':'QoS traffic marking configuration for differentiated services code points.',
    'network-ipgroups':'Reusable IP address collections for firewall and network rule management.',
    'network-ipam':'IP address management pools for centralized address allocation tracking.',
    'network-sep':'Restrict VNet service endpoint access to specific Azure resource instances.',
    'network-tap':'Mirror network traffic from NICs for monitoring and analytics appliances.',
    'network-vrouter':'Route server enabling BGP peering between NVAs and Azure virtual network.',
    'network-webcats':'URL categorisation database for Azure Firewall web filtering rules.',
    'network-verifier':'Network reachability analysis and intent verification between endpoints.',
    'storage-accounts':'GPv2, BlobStorage, BlockBlob, FileStorage with LRS, ZRS, GRS, GZRS redundancy options.',
    'storage-blob':'Block, append, page blobs with hot, cool, cold, archive tiers and lifecycle policies.',
    'storage-adls':'Hierarchical namespace with POSIX ACLs and directory-level permissions for analytics.',
    'storage-files':'SMB 3.x and NFS 4.1 shares with standard HDD/SSD and premium SSD tiers.',
    'storage-queue':'Message queuing with 64 KB messages, 7-day retention, and visibility timeout.',
    'storage-table':'NoSQL key-value store with OData protocol and partition/row key design.',
    'storage-immutable':'WORM policies with legal hold, time-based retention, and version-level immutability.',
    'storage-versioning':'Automatic version creation on blob overwrite/delete with version-level management.',
    'storage-softdelete':'Blob, container, and file share soft delete with configurable retention periods.',
    'storage-encryption':'Microsoft-managed or customer-managed keys per scope with infrastructure encryption.',
    'storage-replication':'Async cross-region or cross-account blob replication with prefix filters.',
    'storage-static':'Static website hosting with index document, error document, and CDN integration.',
    'storage-firewall':'IP rules, VNet rules, resource instance rules, trusted Azure service exceptions.',
    'storage-pe':'Per-service private endpoints for blob, file, queue, table, DFS, and web.',
    'storage-sas':'Account SAS, service SAS, user delegation SAS with stored access policies.',
    'storage-tasks':'Automated data management actions with conditions, assignments, and reporting.',
    'keyvault-standard':'Software-protected keys, secrets, certificates with RBAC or access policy authorization.',
    'keyvault-premium':'HSM-backed keys (FIPS 140-2 Level 2) with software-protected secrets and certs.',
    'keyvault-mhsm':'Dedicated FIPS 140-2 Level 3 HSM with single-tenant, customer-controlled security domain.',
    'keyvault-keys':'RSA, EC, AES keys for wrap/unwrap, sign/verify, encrypt/decrypt operations.',
    'keyvault-secrets':'Arbitrary byte sequences up to 25 KB for connection strings, passwords, API keys.',
    'keyvault-certs':'Self-signed or CA-issued certificates with PKCS#12/PEM format and auto-renewal.',
    'keyvault-rotation':'Automatic key rotation with time-based triggers and pre-expiry notifications.',
    'keyvault-access':'Vault access policies vs Azure RBAC with per-key, per-secret, per-cert permissions.',
    'keyvault-softdelete':'90-day retention with purge protection lock and deleted object recovery.',
    'keyvault-pe':'Private endpoint connectivity with IP rules, VNet rules, and trusted service bypass.',
    'keyvault-backup':'Individual key/secret/certificate backup with cross-region restore for Managed HSM.',
    'sql-db':'Provisioned DTU/vCore or serverless vCore with General Purpose, Business Critical, Hyperscale tiers.',
    'sql-elastic':'Shared DTU or vCore resources across multiple databases in a single pool.',
    'sql-hyperscale':'Up to 100 TB with read scale-out, named replicas, fast scale up/down, 35-day PITR.',
    'sql-mi':'Near 100% SQL Server compatibility with VNet injection and link feature for hybrid.',
    'sql-mipools':'Shared compute resources across multiple managed instances in a pool.',
    'sql-jobs':'Cross-database T-SQL job scheduling via elastic job agents.',
    'sql-failover':'Automatic/manual geo-failover with read/write and read-only listener endpoints.',
    'sql-georep':'Active geo-replication with up to 4 readable secondary databases.',
    'sql-ltr':'Weekly, monthly, yearly backup retention up to 10 years for compliance.',
    'sql-pitr':'Point-in-time restore from 1-35 days with LRS/ZRS/GRS backup storage.',
    'sql-tde':'Transparent data encryption with service-managed or customer-managed keys in Key Vault.',
    'sql-ae':'Client-side column encryption with secure enclave support for rich queries on encrypted data.',
    'sql-audit':'Server and database-level audit logging to Storage, Log Analytics, or Event Hub.',
    'sql-atp':'SQL injection detection, anomalous access patterns, and brute force alert detection.',
    'sql-va':'Security scanning with baseline management and remediation script generation.',
    'sql-ddm':'Default, email, random, and custom string masking for sensitive columns.',
    'sql-ledger':'Tamper-evident and append-only ledger tables with cryptographic digest management.',
    'sql-sync':'Bi-directional data sync between SQL databases and on-premises SQL Server.',
    'sql-dnsalias':'CNAME indirection for connection string stability during server migrations.',
    'sql-vc':'Managed Instance infrastructure grouping for networking and management.',
    'sql-devops':'Azure DevOps pipeline audit logging for SQL operations tracking.',
    'aks-cluster':'Managed Kubernetes control plane with free, standard, and premium tiers.',
    'aks-syspools':'CoreDNS, kube-proxy, metrics-server with taint-based workload segregation.',
    'aks-userpools':'Application workloads with auto-scaling, spot instances, ARM64, GPU, confidential VMs.',
    'aks-vnodes':'ACI burst-based serverless containers within AKS for elastic scaling.',
    'aks-fleet':'Multi-cluster orchestration with update management and workload propagation.',
    'aks-extensions':'Flux GitOps, Dapr, Azure ML, Key Vault CSI Driver, Azure Policy extensions.',
    'aks-maintenance':'Planned maintenance windows for control plane and node OS updates.',
    'aks-snapshots':'Node pool snapshots for rollback, cloning, and disaster recovery.',
    'aks-trustedaccess':'Azure service access to AKS clusters via managed role bindings.',
    'aks-netpolicy':'Azure NPM, Calico, Cilium with kubenet, Azure CNI, CNI Overlay plugins.',
    'aks-workloadid':'OIDC issuer with federated credentials for pod-level managed identity.',
    'aks-automatic':'Opinionated Kubernetes with auto node provisioning, scaling, and networking.',
    'aks-imgclean':'Stale container image garbage collection to free node disk space.',
    'aks-backup':'AKS backup via Velero integration with Azure Backup service.',
    'web-apps':'Windows/Linux/container hosting for .NET, Java, Node.js, Python, PHP, Ruby apps.',
    'web-functions':'Consumption, Flex, Premium, Dedicated plans with HTTP, Timer, Blob, Queue triggers.',
    'web-plans':'Free, Shared, Basic, Standard, Premium v3, Isolated v2 tiers with scaling.',
    'web-ase':'ASE v3 with internal/external load balancer, zone redundancy, dedicated isolated network.',
    'web-slots':'Staging/canary/A-B testing with slot swaps, auto-swap, and traffic routing.',
    'web-certs':'Standard and wildcard certificates with Key Vault integration and auto-renewal.',
    'web-domains':'Domain registration with DNS management and privacy protection.',
    'web-staticapps':'Global CDN with serverless API backends, GitHub/DevOps CI/CD, auth providers.',
    'web-hybrid':'TCP relay through Azure Relay for on-premises resource access without VPN.',
    'web-webjobs':'Continuous and triggered background tasks running within App Service.',
    'web-managedcerts':'Free SSL certificates for custom domains with automatic provisioning.',
    'web-vnetint':'Regional VNet integration with subnet delegation for outbound connectivity.',
    'insights-metrics':'Platform metrics, custom metrics, and Prometheus metrics collection and querying.',
    'insights-alerts':'Static thresholds, dynamic thresholds, multi-resource, multi-condition alert rules.',
    'insights-actlog':'Subscription-level operations, service health, autoscale, and security events.',
    'insights-actlogalerts':'Administrative, service health, resource health, and recommendation alert rules.',
    'insights-sqr':'Log alerts using KQL with cross-resource queries and frequency scheduling.',
    'insights-actiongroups':'Email, SMS, voice, webhook, ITSM, Event Hub, Logic App, Function, Runbook targets.',
    'insights-autoscale':'Metric-based, schedule-based, and predictive autoscale with cooldown rules.',
    'insights-diagnostic':'Platform logs and metrics routing to Log Analytics, Storage, Event Hub.',
    'insights-appinsights':'APM with distributed tracing, dependency tracking, Live Metrics, availability tests.',
    'insights-profiler':'Code-level performance tracing for production workload bottleneck analysis.',
    'insights-snapshot':'Production exception debugging with automatic snapshot collection.',
    'insights-dcr':'Data transformations, filtering, and multi-destination routing with log ingestion API.',
    'insights-dce':'Ingestion and configuration endpoints for data collection pipeline.',
    'insights-pls':'Private connectivity for Monitor, Log Analytics, and App Insights via AMPLS.',
    'insights-workbooks':'Interactive data visualization with parameterized queries and cross-resource dashboards.',
    'insights-webtests':'URL ping tests, multi-step availability tests, and standard web tests.',
    'security-servers':'Plan 1: basic EDR. Plan 2: full MDE, vulnerability assessment, file integrity, adaptive controls.',
    'security-appservice':'Threat detection for web apps and APIs hosted on App Service.',
    'security-sql':'Threat detection and vulnerability assessment for SQL Database and Synapse.',
    'security-sqlmachines':'Protection for SQL Server on VMs and Arc-enabled SQL instances.',
    'security-opensource':'Threat detection for Azure Database for PostgreSQL, MySQL, and MariaDB.',
    'security-storage':'Malware scanning, sensitive data threat detection, and activity monitoring.',
    'security-containers':'Runtime protection, image scanning, Kubernetes policy, CI/CD pipeline scanning.',
    'security-keyvault':'Anomalous access detection, secret/key enumeration, and suspicious operation alerts.',
    'security-dns':'Domain generation algorithm detection, DNS tunneling, and malicious domain alerts.',
    'security-arm':'Suspicious ARM operations, lateral movement, and persistence attempt detection.',
    'security-apis':'API threat detection, anomalous usage patterns, and OWASP API risk alerts.',
    'security-cspm':'Attack path analysis, cloud security graph, and agentless scanning posture management.',
    'security-alerts':'Prioritized security alerts with kill chain mapping and incident grouping.',
    'security-assessments':'Benchmark-based security posture evaluation with remediation recommendations.',
    'security-score':'Quantified security posture score across subscriptions and resources.',
    'security-compliance':'PCI DSS, ISO 27001, NIST 800-53, SOC 2, CIS, HIPAA, FedRAMP assessments.',
    'security-jit':'Time-limited RDP/SSH port opening with approval workflow and NSG automation.',
    'security-appcontrols':'Application allow-listing policy recommendations and enforcement.',
    'security-anhr':'NSG rule tightening recommendations based on actual traffic analysis.',
    'security-fim':'Registry, OS files, and application files change detection and alerting.',
    'security-automation':'Trigger Logic Apps on security alerts, recommendations, or compliance changes.',
    'security-autoprov':'Automatic agent deployment for Log Analytics, Azure Monitor, MDE, Qualys.',
    'security-multicloud':'AWS and GCP CSPM and workload protection via cross-cloud connectors.',
    'security-devops':'Azure DevOps, GitHub, GitLab code scanning, IaC scanning, secrets detection.',
    'auth-rbac':'400+ built-in roles, custom role definitions, and deny assignments for access control.',
    'auth-roleassign':'Scope hierarchy from management group to resource with conditions and principal types.',
    'auth-customroles':'JSON-based actions, notActions, dataActions, notDataActions, and assignable scopes.',
    'auth-policydef':'1000+ built-in policies with Audit, Deny, Modify, DeployIfNotExists effects.',
    'auth-initiatives':'Policy sets for regulatory compliance, security baselines, and organizational standards.',
    'auth-assignments':'Scope, exclusions, enforcement mode, managed identity, and non-compliance messages.',
    'auth-remediation':'Resource remediation for DeployIfNotExists and Modify policies with parallel execution.',
    'auth-exemptions':'Waiver or mitigated time-bound resource-specific policy exceptions.',
    'auth-locks':'CanNotDelete and ReadOnly locks with scope-based inheritance and lock notes.',
    'auth-pim':'Just-in-time role activation with approval workflows, MFA, and time-bound assignments.',
    'auth-accessreviews':'Periodic recertification of role assignments, group membership, and app access.',
    'auth-blueprints':'Environment templates with RBAC, policy, ARM templates (deprecated, use Bicep/templates).',
    'auth-conditions':'Attribute-based access control with storage blob and role assignment conditions.',
    'auth-eligible':'PIM-managed assignments requiring activation, MFA, justification, and approval chain.',
};

// ============================================================
// DATA — PARENT-PARENT EDGES [source, target, strength]
// ============================================================
const PARENT_EDGES = [
    ['Compute','Network',1.0],['Compute','Storage',0.8],['Compute','KeyVault',0.6],
    ['Compute','Insights',0.7],['Compute','Security',0.5],['Compute','Authorization',0.4],
    ['ContainerService','Network',0.9],['ContainerService','Compute',0.7],
    ['ContainerService','Insights',0.6],['ContainerService','KeyVault',0.5],
    ['ContainerService','Storage',0.4],['ContainerService','Authorization',0.4],
    ['Web','Network',0.7],['Web','Storage',0.5],['Web','KeyVault',0.6],
    ['Web','Insights',0.8],['Web','SQL',0.7],['Web','Security',0.4],
    ['SQL','Network',0.6],['SQL','KeyVault',0.7],['SQL','Insights',0.5],
    ['SQL','Security',0.5],['SQL','Storage',0.4],
    ['Storage','Network',0.6],['Storage','KeyVault',0.7],['Storage','Insights',0.5],
    ['KeyVault','Insights',0.4],['KeyVault','Authorization',0.5],
    ['Security','Insights',0.6],['Security','Authorization',0.7],['Security','Network',0.5],
    ['Authorization','Insights',0.4],['Network','Insights',0.6],
];

// ============================================================
// DATA — CROSS-PROVIDER SUB-NODE EDGES [source, target, strength]
// ============================================================
const CROSS_EDGES = [
    // Compute <-> Network
    ['compute-vms','network-vnet',0.9],['compute-vms','network-nsg',0.7],
    ['compute-vms','network-nic',0.9],['compute-vms','network-pip',0.5],
    ['compute-vms','network-lb',0.5],['compute-vms','network-bastion',0.7],
    ['compute-vmss','network-vnet',0.7],['compute-vmss','network-lb',0.8],
    ['compute-vmss','network-appgw',0.6],
    // Compute <-> Storage/KeyVault
    ['compute-disks','keyvault-keys',0.7],['compute-des','keyvault-keys',0.9],
    ['compute-vms','storage-accounts',0.4],
    // Compute <-> Monitor/Security/Auth
    ['compute-vms','insights-appinsights',0.4],['compute-vmss','insights-autoscale',0.8],
    ['compute-vms','security-servers',0.8],['compute-vms','security-jit',0.7],
    ['compute-vms','auth-rbac',0.4],
    // AKS <-> various
    ['aks-cluster','network-vnet',0.8],['aks-cluster','network-firewall',0.5],
    ['aks-cluster','network-lb',0.5],['aks-cluster','keyvault-secrets',0.6],
    ['aks-cluster','insights-appinsights',0.5],['aks-cluster','security-containers',0.8],
    ['aks-cluster','auth-rbac',0.5],['aks-userpools','compute-vmss',0.6],
    ['aks-vnodes','network-vnet',0.4],['aks-workloadid','auth-rbac',0.6],
    ['aks-netpolicy','network-nsg',0.5],
    // Web <-> various
    ['web-apps','network-vnet',0.5],['web-apps','insights-appinsights',0.9],
    ['web-apps','keyvault-secrets',0.7],['web-apps','sql-db',0.7],
    ['web-apps','storage-accounts',0.5],['web-apps','network-pe',0.4],
    ['web-apps','security-appservice',0.7],
    ['web-functions','storage-accounts',0.9],['web-functions','insights-appinsights',0.7],
    ['web-functions','keyvault-secrets',0.5],['web-functions','storage-blob',0.6],
    ['web-functions','storage-queue',0.5],
    ['web-staticapps','network-dns',0.4],['web-plans','insights-autoscale',0.6],
    ['web-vnetint','network-vnet',0.9],['web-certs','keyvault-certs',0.8],
    // SQL <-> various
    ['sql-db','network-pe',0.5],['sql-db','keyvault-keys',0.5],
    ['sql-db','security-sql',0.8],['sql-db','insights-diagnostic',0.4],
    ['sql-tde','keyvault-keys',0.9],['sql-audit','storage-accounts',0.6],
    ['sql-ae','keyvault-keys',0.7],
    ['sql-mi','network-vnet',0.8],['sql-mi','network-nsg',0.5],
    ['sql-failover','network-dns',0.3],
    // Storage <-> various
    ['storage-accounts','network-pe',0.6],['storage-encryption','keyvault-keys',0.9],
    ['storage-accounts','security-storage',0.7],['storage-accounts','insights-diagnostic',0.4],
    ['storage-accounts','auth-rbac',0.5],['storage-firewall','network-vnet',0.5],
    ['storage-files','compute-vms',0.3],
    // KeyVault <-> various
    ['keyvault-pe','network-pe',0.7],['keyvault-certs','network-appgw',0.5],
    ['keyvault-standard','security-keyvault',0.7],['keyvault-access','auth-rbac',0.7],
    // Security/Defender <-> targets
    ['security-cspm','auth-policydef',0.6],['security-jit','network-nsg',0.5],
    ['security-compliance','auth-policydef',0.6],['security-fim','compute-vms',0.4],
    ['security-autoprov','insights-dcr',0.4],['security-anhr','network-nsg',0.4],
    // Insights <-> various
    ['insights-pls','network-pe',0.6],['insights-webtests','web-apps',0.5],
    // Auth <-> various
    ['auth-conditions','storage-accounts',0.4],['auth-policydef','insights-diagnostic',0.3],
];

// ============================================================
// INITIALIZATION — Build node & edge objects
// ============================================================
const nodeMap = {};
const parentMap = {};
parentNodes.forEach(n => {
    n.vx = 0; n.vy = 0;
    n.connections = new Set();
    nodeMap[n.id] = n;
    parentMap[n.id] = n;
});

const maxScore = Math.max(...parentNodes.map(n => n.score));
parentNodes.forEach(n => {
    n.radius = 22 + (n.score / maxScore) * 36;
});

// Create sub-nodes from compact defs
const subNodes = SUB_DEFS.map(([id, label, parentId]) => {
    const parent = parentMap[parentId];
    const node = {
        id, label, parentId,
        isParent: false,
        category: parent.category,
        regions: parent.regions,
        radius: 9 + (parent.score / maxScore) * 5,
        vx: 0, vy: 0,
        connections: new Set(),
    };
    nodeMap[id] = node;
    return node;
});

const allNodes = [...parentNodes, ...subNodes];

// Build edge data objects
const parentEdgeData = PARENT_EDGES
    .map(([s,t,str]) => ({source: nodeMap[s], target: nodeMap[t], strength: str, type:'parent'}))
    .filter(e => e.source && e.target);

const childEdgeData = subNodes.map(sub => ({
    source: parentMap[sub.parentId],
    target: sub,
    strength: 0.5,
    type: 'child'
}));

const crossEdgeData = CROSS_EDGES
    .map(([s,t,str]) => ({source: nodeMap[s], target: nodeMap[t], strength: str, type:'cross'}))
    .filter(e => e.source && e.target);

// Pre-compute connection sets
const allEdges = [...parentEdgeData, ...childEdgeData, ...crossEdgeData];
allEdges.forEach(e => {
    e.source.connections.add(e.target);
    e.target.connections.add(e.source);
});

// Update sub-stats
document.getElementById('sub-stats').textContent =
    `${subNodes.length} sub-services across ${parentNodes.length} providers`;

// ============================================================
// FILTER STATE
// ============================================================
let activeCategories = new Set(Object.keys(CATEGORIES));
let activeRegions = new Set();
let showSubs = true;

// Collect unique regions (exclude 'Global' from filter list)
const allRegions = [...new Set(allNodes.flatMap(n => n.regions))].filter(r => r !== 'Global').sort();
allRegions.forEach(r => activeRegions.add(r));

function isNodeActive(n) {
    if (!activeCategories.has(n.category)) return false;
    if (activeRegions.size === allRegions.length) return true; // all selected = no region filter
    // Global resources are available everywhere
    if (n.regions.includes('Global')) return true;
    return n.regions.some(r => activeRegions.has(r));
}

// ============================================================
// FILTER UI
// ============================================================
function buildCategoryFilters() {
    const container = document.getElementById('cat-filters');
    const h3 = container.querySelector('h3');
    container.innerHTML = '';
    container.appendChild(h3);

    Object.entries(CATEGORIES).forEach(([key, cat]) => {
        const item = document.createElement('div');
        item.className = 'filter-item active';
        item.dataset.cat = key;
        item.innerHTML = `<div class="filter-cb"></div><div class="cat-dot" style="background:${cat.color};box-shadow:0 0 4px ${cat.glow}"></div><span>${cat.label}</span>`;
        item.addEventListener('click', () => {
            if (activeCategories.has(key)) {
                activeCategories.delete(key);
                item.classList.remove('active');
                item.classList.add('dimmed');
            } else {
                activeCategories.add(key);
                item.classList.add('active');
                item.classList.remove('dimmed');
            }
            updateVisibility();
        });
        container.appendChild(item);
    });
    updateCatCount();
}

function buildRegionFilters(filter = '') {
    const container = document.getElementById('region-list');
    container.innerHTML = '';
    const lf = filter.toLowerCase();
    const filtered = lf ? allRegions.filter(r => r.toLowerCase().includes(lf)) : allRegions;

    filtered.forEach(region => {
        const item = document.createElement('div');
        const isActive = activeRegions.has(region);
        item.className = 'filter-item' + (isActive ? ' active' : ' dimmed');
        item.dataset.region = region;
        item.innerHTML = `<div class="filter-cb"></div><span>${region}</span>`;
        item.addEventListener('click', () => {
            if (activeRegions.has(region)) {
                activeRegions.delete(region);
                item.classList.remove('active');
                item.classList.add('dimmed');
            } else {
                activeRegions.add(region);
                item.classList.add('active');
                item.classList.remove('dimmed');
            }
            updateVisibility();
        });
        container.appendChild(item);
    });
    updateRegionCount();
}

function updateCatCount() {
    document.getElementById('cat-count').textContent = `${activeCategories.size}/${Object.keys(CATEGORIES).length}`;
}
function updateRegionCount() {
    document.getElementById('region-count').textContent = `${activeRegions.size}/${allRegions.length}`;
}

function updateVisibility() {
    allNodes.forEach(n => { n.active = isNodeActive(n); });
    updateCatCount();
    updateRegionCount();
}

// Sub-service toggle
document.getElementById('toggle-row-subs').addEventListener('click', () => {
    showSubs = !showSubs;
    const sw = document.getElementById('toggle-subs');
    sw.classList.toggle('on', showSubs);
    if (showSubs) repositionSubs();
});

document.getElementById('region-search').addEventListener('input', e => {
    buildRegionFilters(e.target.value);
});
document.getElementById('regions-all').addEventListener('click', () => {
    activeRegions = new Set(allRegions);
    buildRegionFilters(document.getElementById('region-search').value);
    updateVisibility();
});
document.getElementById('regions-none').addEventListener('click', () => {
    activeRegions.clear();
    buildRegionFilters(document.getElementById('region-search').value);
    updateVisibility();
});

buildCategoryFilters();
buildRegionFilters();
allNodes.forEach(n => { n.active = true; });

// ============================================================
// GRAPH ENGINE
// ============================================================
const canvas = document.getElementById('graph');
const ctx = canvas.getContext('2d');
const tooltip = document.getElementById('tooltip');
const panelWidth = 280;

let W, H, dpr;
let frozen = false;
let dragging = null;
let hovering = null;
let selected = null;   // click-pinned node
let detailOpen = false;
let panX = 0, panY = 0, zoom = 1;
let lastMouse = { x: 0, y: 0 };
let isPanning = false;
let mouseDownPos = null; // for click vs drag detection
const CLICK_THRESHOLD = 5;

function resize() {
    dpr = window.devicePixelRatio || 1;
    const detailW = detailOpen ? 340 : 0;
    W = window.innerWidth - panelWidth - detailW;
    H = window.innerHeight;
    canvas.width = W * dpr;
    canvas.height = H * dpr;
    canvas.style.width = W + 'px';
    canvas.style.height = H + 'px';
    canvas.style.right = detailW + 'px';
    document.querySelector('.header').style.right = detailW + 'px';
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}
window.addEventListener('resize', resize);
resize();

// Initial positions — parents in circle, children around parents
parentNodes.forEach((n, i) => {
    const angle = (i / parentNodes.length) * Math.PI * 2 - Math.PI / 2;
    const r = Math.min(W, H) * 0.3;
    n.x = W / 2 + Math.cos(angle) * r;
    n.y = H / 2 + Math.sin(angle) * r;
});

function repositionSubs() {
    parentNodes.forEach(parent => {
        const children = subNodes.filter(s => s.parentId === parent.id);
        children.forEach((child, i) => {
            const angle = (i / children.length) * Math.PI * 2;
            const dist = parent.radius + 40 + Math.random() * 20;
            child.x = parent.x + Math.cos(angle) * dist;
            child.y = parent.y + Math.sin(angle) * dist;
            child.vx = 0; child.vy = 0;
        });
    });
}
repositionSubs();

// Physics
function simulate() {
    if (frozen) return;
    const centerX = W / 2, centerY = H / 2;
    const damping = 0.88, dt = 0.6;
    const active = showSubs ? allNodes : parentNodes;

    // Repulsion
    for (let i = 0; i < active.length; i++) {
        for (let j = i + 1; j < active.length; j++) {
            const a = active[i], b = active[j];
            let dx = b.x - a.x, dy = b.y - a.y;
            let dist = Math.sqrt(dx * dx + dy * dy) || 1;
            const bothParent = a.isParent && b.isParent;
            const eitherParent = a.isParent || b.isParent;
            const repulse = bothParent ? 32000 : (eitherParent ? 4000 : 1500);
            const force = repulse / (dist * dist);
            const fx = (dx / dist) * force, fy = (dy / dist) * force;
            a.vx -= fx * dt; a.vy -= fy * dt;
            b.vx += fx * dt; b.vy += fy * dt;
        }
    }

    // Parent-parent springs
    parentEdgeData.forEach(e => {
        const dx = e.target.x - e.source.x, dy = e.target.y - e.source.y;
        const dist = Math.sqrt(dx * dx + dy * dy) || 1;
        const idealDist = 250 + (1 - e.strength) * 150;
        const force = (dist - idealDist) * 0.004 * e.strength;
        const fx = (dx / dist) * force, fy = (dy / dist) * force;
        e.source.vx += fx * dt; e.source.vy += fy * dt;
        e.target.vx -= fx * dt; e.target.vy -= fy * dt;
    });

    // Child springs (parent <-> child)
    if (showSubs) {
        childEdgeData.forEach(e => {
            const dx = e.target.x - e.source.x, dy = e.target.y - e.source.y;
            const dist = Math.sqrt(dx * dx + dy * dy) || 1;
            const idealDist = e.source.radius + 55;
            const force = (dist - idealDist) * 0.018;
            const fx = (dx / dist) * force, fy = (dy / dist) * force;
            e.source.vx += fx * dt * 0.3; e.source.vy += fy * dt * 0.3;
            e.target.vx -= fx * dt; e.target.vy -= fy * dt;
        });

        // Cross springs
        crossEdgeData.forEach(e => {
            const dx = e.target.x - e.source.x, dy = e.target.y - e.source.y;
            const dist = Math.sqrt(dx * dx + dy * dy) || 1;
            const idealDist = 200;
            const force = (dist - idealDist) * 0.002 * e.strength;
            const fx = (dx / dist) * force, fy = (dy / dist) * force;
            e.source.vx += fx * dt; e.source.vy += fy * dt;
            e.target.vx -= fx * dt; e.target.vy -= fy * dt;
        });
    }

    // Center gravity + damping
    active.forEach(n => {
        if (n === dragging) return;
        const grav = n.isParent ? 0.0004 : 0.0001;
        n.vx += (centerX - n.x) * grav * dt;
        n.vy += (centerY - n.y) * grav * dt;
        n.vx *= damping; n.vy *= damping;
        n.x += n.vx; n.y += n.vy;
    });
}

// Drawing
function draw() {
    ctx.clearRect(0, 0, W, H);
    ctx.save();
    ctx.translate(panX, panY);
    ctx.scale(zoom, zoom);

    const visNodes = showSubs ? allNodes : parentNodes;
    const anyFilter = visNodes.some(n => !n.active);
    const highlight = hovering || selected;
    const connSet = highlight ? highlight.connections : null;

    // --- EDGES ---
    // Cross edges (behind everything)
    if (showSubs) {
        ctx.setLineDash([3, 3]);
        crossEdgeData.forEach(e => {
            const bothActive = e.source.active && e.target.active;
            const isHov = highlight && (e.source === highlight || e.target === highlight);
            const isConnHov = highlight && connSet && connSet.has(e.source) && connSet.has(e.target);
            let alpha;
            if (isHov) alpha = 0.45;
            else if (isConnHov) alpha = 0.25;
            else if (highlight) alpha = 0.02;
            else if (anyFilter && !bothActive) alpha = 0.02;
            else alpha = 0.06 + e.strength * 0.08;
            ctx.beginPath();
            ctx.moveTo(e.source.x, e.source.y);
            ctx.lineTo(e.target.x, e.target.y);
            ctx.strokeStyle = `rgba(167,139,250,${alpha})`;
            ctx.lineWidth = 0.8;
            ctx.stroke();
        });
        ctx.setLineDash([]);
    }

    // Child edges
    if (showSubs) {
        childEdgeData.forEach(e => {
            const bothActive = e.source.active && e.target.active;
            const isHov = highlight && (e.source === highlight || e.target === highlight);
            let alpha;
            if (isHov) alpha = 0.4;
            else if (highlight) alpha = 0.03;
            else if (anyFilter && !bothActive) alpha = 0.02;
            else alpha = 0.12;
            const cat = CATEGORIES[e.target.category];
            ctx.beginPath();
            ctx.moveTo(e.source.x, e.source.y);
            ctx.lineTo(e.target.x, e.target.y);
            ctx.strokeStyle = adjustAlpha(cat.color, alpha);
            ctx.lineWidth = 0.8;
            ctx.stroke();
        });
    }

    // Parent-parent edges
    parentEdgeData.forEach(e => {
        const bothActive = e.source.active && e.target.active;
        const isHov = highlight && (e.source === highlight || e.target === highlight);
        const filterDim = anyFilter && !bothActive;
        let alpha;
        if (isHov) alpha = 0.6;
        else if (highlight) alpha = 0.05;
        else if (filterDim) alpha = 0.04;
        else alpha = 0.12 + e.strength * 0.2;
        const width = 1 + e.strength * 2.5;
        ctx.beginPath();
        ctx.moveTo(e.source.x, e.source.y);
        ctx.lineTo(e.target.x, e.target.y);
        ctx.strokeStyle = isHov ? `rgba(80,230,255,${alpha})` : `rgba(59,158,255,${alpha})`;
        ctx.lineWidth = isHov ? width + 1 : width;
        ctx.stroke();
        if (isHov) {
            ctx.shadowColor = 'rgba(80,230,255,0.3)'; ctx.shadowBlur = 8;
            ctx.stroke(); ctx.shadowBlur = 0;
        }
    });

    // --- NODES ---
    const sorted = [...visNodes].sort((a, b) => {
        const aScore = (a.active ? 2 : 0) + (a.isParent ? 1 : 0);
        const bScore = (b.active ? 2 : 0) + (b.isParent ? 1 : 0);
        return aScore - bScore;
    });

    sorted.forEach(n => {
        const cat = CATEGORIES[n.category];
        const isHighlighted = n === highlight;
        const isConnected = connSet && connSet.has(n);
        const highlightDimmed = highlight && !isHighlighted && !isConnected;
        const filterInactive = anyFilter && !n.active;
        const isSelected = n === selected;

        let nodeOpacity;
        if (filterInactive) nodeOpacity = 0.12;
        else if (highlightDimmed) nodeOpacity = 0.15;
        else nodeOpacity = 1;

        if (!n.isParent && !isHighlighted && !isConnected && nodeOpacity === 1) {
            nodeOpacity = 0.85;
        }

        // Selected node ring
        if (isSelected && !filterInactive) {
            ctx.save();
            ctx.strokeStyle = '#22d3ee';
            ctx.lineWidth = 2.5;
            ctx.shadowColor = 'rgba(34,211,238,0.6)'; ctx.shadowBlur = 18;
            ctx.setLineDash([4, 3]);
            ctx.beginPath(); ctx.arc(n.x, n.y, n.radius + 6, 0, Math.PI * 2);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.restore();
        }

        // Glow for highlighted active nodes
        if (isHighlighted && !filterInactive) {
            ctx.save();
            ctx.shadowColor = cat.glow; ctx.shadowBlur = n.isParent ? 35 : 20;
            ctx.beginPath(); ctx.arc(n.x, n.y, n.radius + 4, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(0,0,0,0)'; ctx.fill();
            ctx.restore();
        }

        // Circle fill
        const grad = ctx.createRadialGradient(
            n.x - n.radius * 0.3, n.y - n.radius * 0.3, n.radius * 0.1,
            n.x, n.y, n.radius
        );
        grad.addColorStop(0, adjustAlpha(lighten(cat.color, n.isParent ? 40 : 55), nodeOpacity));
        grad.addColorStop(1, adjustAlpha(cat.color, nodeOpacity * (n.isParent ? 0.7 : 0.5)));
        ctx.beginPath(); ctx.arc(n.x, n.y, n.radius, 0, Math.PI * 2);
        ctx.fillStyle = grad; ctx.fill();

        // Border
        ctx.strokeStyle = adjustAlpha(
            isHighlighted && !filterInactive ? '#ffffff' : cat.color,
            filterInactive ? 0.06 : (highlightDimmed ? 0.1 : (n.isParent ? 0.5 : 0.35))
        );
        ctx.lineWidth = isHighlighted && !filterInactive ? 2.5 : (n.isParent ? 1.5 : 1);
        ctx.stroke();

        // Label — clipped to circle, with dark backing
        ctx.save();
        ctx.beginPath(); ctx.arc(n.x, n.y, n.radius - 2, 0, Math.PI * 2); ctx.clip();
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';

        const lines = n.label.split('\n');
        let fontSize = n.isParent
            ? Math.max(9, Math.min(14, n.radius * 0.38))
            : Math.max(5, Math.min(9, n.radius * 0.55));

        const calcFit = (fs) => {
            ctx.font = `700 ${fs}px 'Segoe UI', sans-serif`;
            const lh = fs * 1.25;
            const th = lines.length * lh;
            const sy = -(th / 2) + lh / 2;
            for (let li = 0; li < lines.length; li++) {
                const ly = sy + li * lh;
                const r2 = n.radius - 3;
                const chordHalf = Math.sqrt(Math.max(0, r2 * r2 - ly * ly));
                if (ctx.measureText(lines[li]).width > chordHalf * 2 - 4) return false;
            }
            return true;
        };
        for (let attempt = 0; attempt < 10; attempt++) {
            if (calcFit(fontSize)) break;
            fontSize -= 0.5;
        }
        ctx.font = `700 ${fontSize}px 'Segoe UI', sans-serif`;

        const lh = fontSize * 1.25;
        const th = lines.length * lh;
        const sy = n.y - (th / 2) + lh / 2;
        const textAlpha = filterInactive ? 0.1 : (highlightDimmed ? 0.12 : nodeOpacity);

        if (textAlpha > 0.15) {
            ctx.strokeStyle = `rgba(0,0,0,${textAlpha * 0.9})`;
            ctx.lineWidth = n.isParent ? 3 : 2;
            ctx.lineJoin = 'round';
            lines.forEach((line, li) => {
                ctx.strokeText(line, n.x, sy + li * lh);
            });
        }

        ctx.fillStyle = `rgba(255,255,255,${textAlpha})`;
        if (isHighlighted && !filterInactive) {
            ctx.shadowColor = 'rgba(255,255,255,0.5)';
            ctx.shadowBlur = 8;
        }
        lines.forEach((line, li) => {
            ctx.fillText(line, n.x, sy + li * lh);
        });

        ctx.shadowBlur = 0;
        ctx.restore();
    });

    ctx.restore();
}

function adjustAlpha(hex, a) {
    const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
    return `rgba(${r},${g},${b},${a})`;
}
function lighten(hex, p) {
    let r = Math.min(255, parseInt(hex.slice(1,3),16)+p);
    let g = Math.min(255, parseInt(hex.slice(3,5),16)+p);
    let b = Math.min(255, parseInt(hex.slice(5,7),16)+p);
    return '#'+r.toString(16).padStart(2,'0')+g.toString(16).padStart(2,'0')+b.toString(16).padStart(2,'0');
}

// ============================================================
// INTERACTION
// ============================================================
function screenToWorld(sx, sy) {
    return { x: (sx - panelWidth - panX) / zoom, y: (sy - panY) / zoom };
}
function nodeAt(sx, sy) {
    const { x, y } = screenToWorld(sx, sy);
    const visNodes = showSubs ? allNodes : parentNodes;
    // Check in reverse (top-drawn nodes first), prefer parents
    for (let i = visNodes.length - 1; i >= 0; i--) {
        const n = visNodes[i];
        const dx = n.x - x, dy = n.y - y;
        if (dx * dx + dy * dy < n.radius * n.radius) return n;
    }
    return null;
}

canvas.addEventListener('mousedown', e => {
    mouseDownPos = { x: e.clientX, y: e.clientY };
    const n = nodeAt(e.clientX, e.clientY);
    if (n) { dragging = n; canvas.style.cursor = 'grabbing'; }
    else { isPanning = true; lastMouse = {x: e.clientX, y: e.clientY}; canvas.style.cursor = 'grabbing'; }
});

canvas.addEventListener('mousemove', e => {
    if (dragging) {
        const {x, y} = screenToWorld(e.clientX, e.clientY);
        dragging.x = x; dragging.y = y; dragging.vx = 0; dragging.vy = 0;
    } else if (isPanning) {
        panX += e.clientX - lastMouse.x; panY += e.clientY - lastMouse.y;
        lastMouse = {x: e.clientX, y: e.clientY};
    } else {
        const n = nodeAt(e.clientX, e.clientY);
        hovering = n;
        canvas.style.cursor = n ? 'pointer' : 'grab';
        // Tooltip on hover (brief summary)
        if (n) {
            const name = n.label.replace(/\n/g, ' ');
            let html = `<h3>${name}</h3>`;
            if (n.isParent) {
                html += `<div class="tt-type">${n.desc}</div>`;
                html += `<div class="tt-stat"><span class="tt-label">Config Params</span><span class="tt-value">${n.params.toLocaleString()}</span></div>`;
                html += `<div class="tt-stat"><span class="tt-label">Sub-Services</span><span class="tt-value">${subNodes.filter(s=>s.parentId===n.id).length}</span></div>`;
            } else {
                html += `<div class="tt-type">Part of <strong style="color:var(--neon-blue)">${parentMap[n.parentId].label.replace(/\n/g,' ')}</strong></div>`;
            }
            html += `<div style="font-size:0.65rem;color:var(--text-muted);margin-top:0.4rem;border-top:1px solid rgba(255,255,255,0.06);padding-top:0.35rem">Click for details</div>`;
            tooltip.style.display = 'block';
            tooltip.style.left = (e.clientX + 16) + 'px';
            tooltip.style.top = (e.clientY - 10) + 'px';
            tooltip.innerHTML = html;
            const rect = tooltip.getBoundingClientRect();
            if (rect.right > window.innerWidth) tooltip.style.left = (e.clientX - rect.width - 16) + 'px';
            if (rect.bottom > window.innerHeight) tooltip.style.top = (e.clientY - rect.height - 10) + 'px';
        } else {
            tooltip.style.display = 'none';
        }
    }
});

canvas.addEventListener('mouseup', e => {
    const wasDrag = mouseDownPos && (
        Math.abs(e.clientX - mouseDownPos.x) > CLICK_THRESHOLD ||
        Math.abs(e.clientY - mouseDownPos.y) > CLICK_THRESHOLD
    );
    if (!wasDrag && mouseDownPos) {
        const n = nodeAt(e.clientX, e.clientY);
        if (n) {
            if (selected === n) { closeDetail(); }
            else { openDetail(n); }
        } else {
            if (selected) closeDetail();
        }
    }
    dragging = null; isPanning = false; mouseDownPos = null;
    canvas.style.cursor = 'grab';
});
canvas.addEventListener('mouseleave', () => {
    dragging = null; isPanning = false; hovering = null;
    mouseDownPos = null; tooltip.style.display = 'none';
});
canvas.addEventListener('wheel', e => {
    e.preventDefault();
    const f = e.deltaY > 0 ? 0.92 : 1.08;
    const wx = (e.clientX - panelWidth - panX) / zoom;
    const wy = (e.clientY - panY) / zoom;
    zoom = Math.max(0.15, Math.min(8, zoom * f));
    panX = e.clientX - panelWidth - wx * zoom;
    panY = e.clientY - wy * zoom;
}, { passive: false });

document.getElementById('btn-reset').addEventListener('click', () => {
    panX = 0; panY = 0; zoom = 1;
    parentNodes.forEach((n, i) => {
        const angle = (i / parentNodes.length) * Math.PI * 2 - Math.PI / 2;
        const r = Math.min(W, H) * 0.3;
        n.x = W / 2 + Math.cos(angle) * r; n.y = H / 2 + Math.sin(angle) * r;
        n.vx = 0; n.vy = 0;
    });
    repositionSubs();
    frozen = false;
    document.getElementById('btn-freeze').textContent = 'Freeze';
});

document.getElementById('btn-freeze').addEventListener('click', () => {
    frozen = !frozen;
    document.getElementById('btn-freeze').textContent = frozen ? 'Unfreeze' : 'Freeze';
});

// ============================================================
// DETAIL PANEL
// ============================================================
const detailPanel = document.getElementById('detail-panel');
const detailBody = document.getElementById('detail-body');
const detailName = document.getElementById('detail-name');

function strengthDots(val, max = 5) {
    const filled = Math.round(val * max);
    let html = '<div class="strength-bar">';
    for (let i = 0; i < max; i++) html += `<span class="${i < filled ? 'on' : ''}"></span>`;
    return html + '</div>';
}

function openDetail(node) {
    selected = node;
    detailOpen = true;
    detailPanel.classList.add('open');
    tooltip.style.display = 'none';
    resize();
    populateDetail(node);
}

function closeDetail() {
    selected = null;
    detailOpen = false;
    detailPanel.classList.remove('open');
    resize();
}

document.getElementById('detail-close').addEventListener('click', closeDetail);

function selectNode(nodeId) {
    const n = nodeMap[nodeId];
    if (n) openDetail(n);
}

function populateDetail(n) {
    const name = n.label.replace(/\n/g, ' ');
    const cat = CATEGORIES[n.category];
    detailName.innerHTML = name;

    let html = '';
    // Category badge
    html += `<div style="padding:0 1.25rem 0.5rem"><span class="detail-cat-badge" style="background:${adjustAlpha(cat.color,0.15)};color:${cat.color};border:1px solid ${adjustAlpha(cat.color,0.3)}">${cat.label}</span></div>`;

    if (n.isParent) {
        // Description
        html += `<div class="detail-desc">${n.desc}</div>`;
        // Stats
        html += `<div class="detail-section"><h3>Statistics</h3><div class="detail-stat-grid">`;
        html += `<div class="detail-stat-card"><div class="ds-value">${n.params.toLocaleString()}</div><div class="ds-label">Config Parameters</div></div>`;
        html += `<div class="detail-stat-card"><div class="ds-value">${n.resourceTypes}</div><div class="ds-label">Resource Types</div></div>`;
        html += `<div class="detail-stat-card"><div class="ds-value">${n.skus.toLocaleString()}</div><div class="ds-label">SKU Variants</div></div>`;
        html += `<div class="detail-stat-card"><div class="ds-value">${n.operations}</div><div class="ds-label">API Operations</div></div>`;
        html += `</div></div>`;
        // Sub-services
        const children = subNodes.filter(s => s.parentId === n.id);
        html += `<div class="detail-section"><h3>Sub-Services <span class="ds-count">${children.length}</span></h3>`;
        children.forEach(child => {
            const cname = child.label.replace(/\n/g, ' ');
            const desc = SUB_DESCS[child.id] || '';
            html += `<div class="dli" onclick="selectNode('${child.id}')">`;
            html += `<div class="dli-row"><div class="dli-dot" style="background:${cat.color}"></div><span class="dli-name">${cname}</span></div>`;
            if (desc) html += `<div class="dli-desc">${desc}</div>`;
            html += `</div>`;
        });
        html += `</div>`;
        // Connected providers
        const provEdges = parentEdgeData.filter(e => e.source === n || e.target === n);
        if (provEdges.length > 0) {
            html += `<div class="detail-section"><h3>Related Providers <span class="ds-count">${provEdges.length}</span></h3>`;
            provEdges.sort((a,b) => b.strength - a.strength).forEach(e => {
                const other = e.source === n ? e.target : e.source;
                const ocat = CATEGORIES[other.category];
                const oname = other.label.replace(/\n/g, ' ');
                html += `<div class="dli" onclick="selectNode('${other.id}')">`;
                html += `<div class="dli-row"><div class="dli-dot" style="background:${ocat.color}"></div><span class="dli-name">${oname}</span>${strengthDots(e.strength)}</div>`;
                html += `<div class="dli-desc">${other.desc}</div>`;
                html += `</div>`;
            });
            html += `</div>`;
        }
    } else {
        // Sub-node detail
        const desc = SUB_DESCS[n.id] || '';
        if (desc) html += `<div class="detail-desc">${desc}</div>`;
        // Parent
        const parent = parentMap[n.parentId];
        const pcat = CATEGORIES[parent.category];
        html += `<div class="detail-section"><h3>Parent Provider</h3>`;
        html += `<div class="dli" onclick="selectNode('${parent.id}')">`;
        html += `<div class="dli-row"><div class="dli-dot" style="background:${pcat.color}"></div><span class="dli-name">${parent.label.replace(/\n/g,' ')}</span><span class="dli-meta">${parent.params.toLocaleString()} params</span></div>`;
        html += `<div class="dli-desc">${parent.desc}</div>`;
        html += `</div></div>`;
        // Cross-provider related services
        const crossLinks = crossEdgeData.filter(e => e.source === n || e.target === n);
        if (crossLinks.length > 0) {
            // Group by parent provider
            const grouped = {};
            crossLinks.sort((a,b) => b.strength - a.strength).forEach(e => {
                const other = e.source === n ? e.target : e.source;
                const opid = other.isParent ? other.id : other.parentId;
                if (!grouped[opid]) grouped[opid] = [];
                grouped[opid].push({ node: other, strength: e.strength });
            });
            html += `<div class="detail-section"><h3>Related Services <span class="ds-count">${crossLinks.length}</span></h3>`;
            Object.entries(grouped).forEach(([pid, items]) => {
                const pp = parentMap[pid];
                const ppcat = CATEGORIES[pp.category];
                html += `<div style="font-size:0.68rem;color:${ppcat.color};font-weight:600;margin:0.5rem 0 0.2rem;text-transform:uppercase;letter-spacing:0.04em">${pp.label.replace(/\n/g,' ')}</div>`;
                items.forEach(({node: other, strength}) => {
                    const oname = other.label.replace(/\n/g, ' ');
                    const odesc = other.isParent ? other.desc : (SUB_DESCS[other.id] || '');
                    html += `<div class="dli" onclick="selectNode('${other.id}')">`;
                    html += `<div class="dli-row"><div class="dli-dot" style="background:${ppcat.color}"></div><span class="dli-name">${oname}</span>${strengthDots(strength)}</div>`;
                    if (odesc) html += `<div class="dli-desc">${odesc}</div>`;
                    html += `</div>`;
                });
            });
            html += `</div>`;
        }
        // Siblings
        const siblings = subNodes.filter(s => s.parentId === n.parentId && s !== n);
        if (siblings.length > 0) {
            html += `<div class="detail-section"><h3>Sibling Services <span class="ds-count">${siblings.length}</span></h3>`;
            siblings.forEach(sib => {
                const sname = sib.label.replace(/\n/g, ' ');
                html += `<div class="dli" onclick="selectNode('${sib.id}')">`;
                html += `<div class="dli-row"><div class="dli-dot" style="background:${cat.color}"></div><span class="dli-name">${sname}</span></div>`;
                html += `</div>`;
            });
            html += `</div>`;
        }
    }
    // Region availability
    const hasGlobal = n.regions.includes('Global');
    const regionCount = hasGlobal ? allRegions.length : n.regions.filter(r => r !== 'Global').length;
    html += `<div class="detail-regions">`;
    html += `<strong>${hasGlobal ? 'Global — All ' + allRegions.length + ' Regions' : regionCount + ' Regions'}</strong>`;
    html += `<div class="region-tags">`;
    const displayRegions = hasGlobal ? allRegions : n.regions.filter(r => r !== 'Global');
    displayRegions.forEach(r => { html += `<span class="region-tag">${r}</span>`; });
    html += `</div></div>`;

    detailBody.innerHTML = html;
    detailBody.scrollTop = 0;
}

// Animation loop
function loop() { simulate(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>
